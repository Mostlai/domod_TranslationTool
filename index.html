<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
            --input-bg: #0a0a0a;
            
            --gold-primary: #c5a059;
            --gold-glow: rgba(197, 160, 89, 0.2);
            --gold-dim: #7a6030;
            
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.5);
            
            /* Category Colors */
            --tag-unit: #ef5350; --tag-spell: #ab47bc; 
            --tag-item: #fdd835; --tag-site: #26a69a;
            --tag-event: #2e7d32; --tag-nation: #42a5f5; --tag-misc: #78909c;
        }

        [data-theme="light"] {
            --bg-color: #f4f6f8;
            --panel-bg: #ffffff;
            --text-main: #2c3e50;
            --text-dim: #607d8b;
            --border-color: #e0e0e0;
            --input-bg: #f0f2f5;
            --gold-primary: #a67c00; 
            --gold-glow: rgba(166, 124, 0, 0.3);
            --gold-dim: #d4a017;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.1);
            
            --tag-unit: #c62828; --tag-spell: #6a1b9a; 
            --tag-item: #fbc02d; --tag-site: #00695c;
            --tag-event: #2e7d32; --tag-nation: #1565c0; --tag-misc: #455a64;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, var(--gold-glow) 0%, transparent 70%);
            color: var(--text-main);
            font-family: "Segoe UI", "Inter", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column;
            height: 98vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .header-left h1 {
            color: var(--gold-primary); margin: 0;
            font-family: "Palatino Linotype", serif; letter-spacing: 1px;
            text-shadow: 0 2px 10px var(--gold-glow);
        }
        .version-tag { 
            font-size: 11px; background: var(--gold-glow); color: var(--gold-primary); 
            padding: 2px 8px; border-radius: 12px; font-weight: bold; border: 1px solid var(--gold-primary);
            margin-left: 10px; vertical-align: middle;
        }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .theme-toggle { background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-dim); transition:0.3s; }
        .theme-toggle:hover { color:var(--gold-primary); transform: rotate(15deg); }
        .github-link {
            text-decoration: none; color: var(--text-dim); background: var(--panel-bg);
            border: 1px solid var(--border-color); padding: 6px 14px; border-radius: 20px;
            font-size: 13px; display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-soft);
            transition: 0.3s;
        }
        .github-link:hover { color: var(--gold-primary); border-color: var(--gold-primary); transform: translateY(-2px); }

        /* --- Control Panel --- */
        .control-panel {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; margin-bottom: 15px;
            display: grid; grid-template-columns: 220px 1fr 160px; gap: 25px;
            box-shadow: var(--shadow-soft); backdrop-filter: blur(5px);
        }
        .col-title { 
            color: var(--gold-primary); font-size: 13px; font-weight: 700; margin-bottom: 10px; 
            display: block; text-transform: uppercase; letter-spacing: 0.5px; 
            border-bottom: 2px solid var(--border-color); padding-bottom: 5px;
        }

        /* File & Select */
        .col-file { display: flex; flex-direction: column; gap: 12px; }
        select { 
            background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); 
            padding: 8px; border-radius: 6px; width: 100%; outline: none; cursor: pointer;
        }
        
        /* Config Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            background: var(--input-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .config-group { display: flex; flex-direction: column; gap: 4px; }
        .head { 
            font-size: 11px; font-weight: bold; color: var(--text-dim); 
            border-bottom: 1px solid var(--border-color); padding-bottom: 2px; margin-bottom: 2px; 
            display: flex; align-items: center; gap: 6px;
        }
        .head i { width: 14px; text-align: center; color: var(--gold-primary); }

        /* Advanced Options */
        .advanced-options {
            grid-column: span 4; border-top: 1px dashed var(--border-color); margin-top: 5px; padding-top: 10px;
            display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px;
        }
        .adv-block {
            display: flex; flex-direction: column; gap: 6px;
            background: var(--panel-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);
        }
        .adv-title { 
            font-size: 11px; color: var(--gold-primary); font-weight: 800; text-transform: uppercase; 
            margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;
        }

        /* Sync Matrix */
        .sync-matrix { display: flex; flex-wrap: wrap; gap: 8px; }
        .sync-item { 
            display: flex; align-items: center; gap: 4px; font-size: 11px; 
            background: var(--input-bg); padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border-color);
            color: var(--text-dim); transition: 0.2s;
        }
        .sync-item:hover { border-color: var(--gold-primary); color: var(--text-main); }

        /* Inputs & Labels */
        label { font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-dim); }
        label:hover { color: var(--text-main); }
        input[type="checkbox"], input[type="radio"] { accent-color: var(--gold-primary); cursor: pointer; }
        
        input[type="number"] { 
            background: var(--input-bg); color: var(--gold-primary); border: 1px solid #555; 
            width: 40px; padding: 2px; text-align: center; font-weight: bold; border-radius: 4px;
        }
        input[type="number"]:focus { border-color: var(--gold-primary); outline: none; }

        /* Actions */
        .col-actions { display: flex; flex-direction: column; gap: 8px; justify-content: center; }
        .btn {
            background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color);
            padding: 8px; cursor: pointer; font-weight: 600; font-size: 12px;
            border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); border-color: var(--gold-primary); }
        .btn-primary { background: linear-gradient(135deg, #a01a1a, #680e0e); color: white; border: none; }
        [data-theme="light"] .btn-primary { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
        .btn-success { background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white; border: none; }
        .btn-purple { background: linear-gradient(135deg, #6200ea, #311b92); color: white; border: none; }
        .btn-fix { background: linear-gradient(135deg, #ff6f00, #e65100); color: white; border: none; }
        .btn-teal { background: linear-gradient(135deg, #00838f, #006064); color: white; border: none; }
        .btn-patch { background: linear-gradient(135deg, #424242, #212121); border: 1px solid var(--gold-dim); color: var(--gold-primary); }

        /* Filter Bar */
        .filter-bar { display: flex; gap: 4px; padding: 0 10px; align-items: flex-end; }
        .tab-btn {
            background: var(--input-bg); border: 1px solid var(--border-color); border-bottom: none;
            color: var(--text-dim); padding: 8px 16px; cursor: pointer; font-size: 11px; font-weight: bold;
            border-radius: 6px 6px 0 0; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .tab-btn.active { 
            background: var(--panel-bg); color: var(--gold-primary); 
            border-top: 3px solid var(--gold-primary); border-bottom: 1px solid var(--panel-bg); 
            z-index: 5; padding-bottom: 10px; margin-top: -2px;
        }
        .tab-btn[data-cat="all"].active { border-top: 3px solid var(--gold-primary); }
        .tab-btn[data-cat="unit"].active { border-top-color: var(--tag-unit); color: var(--tag-unit); }
        .tab-btn[data-cat="spell"].active { border-top-color: var(--tag-spell); color: var(--tag-spell); }
        .tab-btn[data-cat="item"].active { border-top-color: var(--tag-item); color: var(--tag-item); }
        .tab-btn[data-cat="site"].active { border-top-color: var(--tag-site); color: var(--tag-site); }
        .tab-btn[data-cat="nation"].active { border-top-color: var(--tag-nation); color: var(--tag-nation); }
        .tab-btn[data-cat="event"].active { border-top-color: var(--tag-event); color: var(--tag-event); }
        .tab-btn[data-cat="misc"].active { border-top-color: var(--tag-misc); color: var(--tag-misc); }

        .search-container {
            margin-left: auto; display: flex; align-items: center; gap: 8px; 
            background: var(--input-bg); padding: 5px 12px; 
            border-radius: 16px 16px 0 0; border: 1px solid var(--border-color); border-bottom: none;
        }
        .search-input { background: transparent; border: none; color: var(--text-main); width: 140px; font-size: 12px; outline: none; }
        .search-input:focus { width: 200px; }
        .counter { font-size: 11px; color: var(--text-dim); }
        .filter-select { background: transparent; border: none; color: var(--text-dim); font-size: 12px; outline: none; cursor: pointer; border-right: 1px solid var(--border-color); padding-right: 8px; margin-right: 5px; }
        .filter-select option { background: var(--input-bg); color: var(--text-main); }

        /* Table */
        .table-wrap { flex: 1; overflow-y: auto; border: 1px solid var(--border-color); background: var(--panel-bg); box-shadow: var(--shadow-soft); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        th { 
            background: var(--input-bg); color: var(--gold-primary); padding: 12px; 
            position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border-color); text-align: left;
        }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); vertical-align: top; color: var(--text-main); line-height: 1.5; word-wrap: break-word; }
        tr:nth-child(even) { background: rgba(128,128,128,0.02); }
        tr:hover { background: var(--gold-glow); }

        textarea {
            width: 97%; background: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--border-color); border-radius: 4px; padding: 6px;
            resize: vertical; font-family: inherit; line-height: 1.5; min-height: 36px; overflow: hidden;
        }
        textarea:focus { border-color: var(--gold-primary); background: var(--panel-bg); box-shadow: 0 0 0 2px var(--gold-glow); outline: none; }

        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: bold; display: inline-block; min-width: 40px; text-align: center; margin-bottom: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        
        .alert-dupe { color: #ff5252; background: rgba(255,82,82,0.1); border: 1px solid #ff5252; padding: 1px 5px; border-radius: 3px; font-size: 10px; margin-right: 5px; display: inline-flex; align-items: center; gap: 3px; cursor: help;}

        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--input-bg); padding: 8px 20px; border: 1px solid var(--border-color); border-top: none;
            border-radius: 0 0 8px 8px;
        }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: zoomIn 0.2s ease; }
        .modal-box { 
            background: var(--panel-bg); border: 1px solid var(--gold-dim); padding: 25px; width: 750px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); border-radius: 10px; display: flex; flex-direction: column; gap: 15px;
        }
        .scope-options { display: flex; gap: 20px; background: var(--input-bg); padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; }
        
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: var(--panel-bg); border-left: 4px solid var(--gold-primary); color: var(--text-main);
            padding: 12px 30px; opacity: 0; transition: 0.3s; z-index: 200; 
            border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); font-weight: bold;
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { opacity: 1; bottom: 60px; }
        
        .glossary-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå° <span class="version-tag">v3.2</span></h1>
    </div>
    <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ—¥å¤œæ¨¡å¼"><i class="fa-solid fa-moon"></i></button>
        <a href="https://github.com/Mostlai/domod_TranslationTool/tree/main" target="_blank" class="github-link"><i class="fa-brands fa-github"></i> GitHub</a>
    </div>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <span class="col-title"><i class="fa-solid fa-file-code"></i> 1. æ–‡ä»¶æ“ä½œ</span>
        <select id="encodingSelect">
            <option value="UTF-8">è¯»å–ç¼–ç : UTF-8 (é»˜è®¤)</option>
            <option value="windows-1252">è¯»å–ç¼–ç : Windows-1252 (æ—§Mod)</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-folder-open"></i> ä¸Šä¼  .dm æ–‡ä»¶
        </button>
    </div>

    <!-- 2. Config -->
    <div class="col-config" style="grid-column: span 1;">
        <span class="col-title"><i class="fa-solid fa-sliders"></i> 2. ç¿»è¯‘èŒƒå›´é…ç½®</span>
        <div class="config-grid">
            <div class="config-group"><div class="head"><i class="fa-solid fa-hat-wizard"></i> æ³•æœ¯</div><label><input type="checkbox" id="cfg_spell_name"> Name</label><label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-chess-knight"></i> å•ä½</div><label><input type="checkbox" id="cfg_unit_name"> Name</label><label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-shield-halved"></i> ç‰©å“</div><label><input type="checkbox" id="cfg_item_name"> Name</label><label><input type="checkbox" id="cfg_item_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-dungeon"></i> é—è¿¹</div><label><input type="checkbox" id="cfg_site_name"> Name</label><label><input type="checkbox" id="cfg_site_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-flag"></i> å›½å®¶</div><label><input type="checkbox" id="cfg_nation_name"> Name</label><label><input type="checkbox" id="cfg_nation_epithet" checked> Epithet</label><label><input type="checkbox" id="cfg_nation_descr" checked> Info</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-scroll"></i> äº‹ä»¶</div><label><input type="checkbox" id="cfg_event_name"> Name</label><label><input type="checkbox" id="cfg_event_descr" checked> Msg</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-layer-group"></i> æ‚é¡¹</div><label><input type="checkbox" id="cfg_misc_name"> Name</label><label><input type="checkbox" id="cfg_misc_descr" checked> Text</label></div>
            
            <!-- Advanced Options -->
            <div class="advanced-options">
                <div class="adv-block">
                    <div class="adv-title">
                        <span><i class="fa-solid fa-link"></i> å…¨å±€åŒæ­¥ (Global Sync)</span>
                        <label style="font-weight:normal; margin:0;"><input type="checkbox" id="opt_global_sync" checked onclick="toggleSyncMatrix(this)"> æ€»å¼€å…³</label>
                    </div>
                    <div class="sync-matrix">
                        <label class="sync-item"><input type="checkbox" id="sync_unit_name" checked> å•ä½</label>
                        <label class="sync-item"><input type="checkbox" id="sync_spell_name" checked> æ³•æœ¯</label>
                        <label class="sync-item"><input type="checkbox" id="sync_item_name" checked> ç‰©å“</label>
                        <label class="sync-item"><input type="checkbox" id="sync_site_name" checked> é—è¿¹</label>
                        <label class="sync-item"><input type="checkbox" id="sync_event_name" checked> äº‹ä»¶</label>
                        <label class="sync-item"><input type="checkbox" id="sync_misc_name" checked> æ‚é¡¹</label>
                        <div style="width:100%; height:1px; background:var(--border-color); margin:2px 0;"></div>
                        <label class="sync-item" style="color:var(--tag-nation)"><input type="checkbox" id="sync_nation_name" checked> å›½å®¶å</label>
                        <label class="sync-item" style="color:var(--tag-nation)"><input type="checkbox" id="sync_nation_epithet"> ç§°å·</label>
                    </div>
                </div>
                <div class="adv-block">
                    <div class="adv-title">
                        <span><i class="fa-solid fa-align-left"></i> æ ¼å¼ä¸è¿‡æ»¤ (Format)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                        <input type="checkbox" id="opt_auto_wrap" checked style="accent-color:#ff4444">
                        <span style="font-size:12px; color:var(--text-dim)">å¼ºåˆ¶æ¢è¡Œå­—æ•°:</span>
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <label title="å›½å®¶Info/Brief">å›½:<input type="number" id="limit_nation" value="55"></label>
                            <label title="æ³•æœ¯Descr">æ³•:<input type="number" id="limit_spell" value="36"></label>
                            <label title="äº‹ä»¶Msg">äº‹:<input type="number" id="limit_event" value="35"></label>
                            <label title="å•ä½/ç‰©å“/å…¶ä»–">ä»–:<input type="number" id="limit_other" value="42"></label>
                        </div>
                    </div>
                    <div style="border-top:1px solid var(--border-color); padding-top:5px; display:flex; flex-direction:column; gap:3px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                             <span style="font-size:11px; color:var(--gold-primary); font-weight:800;">ä¿ç•™åŸæ–‡æ®µè½:</span>
                        </div>
                        <div style="display:flex; gap:10px;">
                             <label title="å¼€å¯åä¿ç•™#descrä¸­çš„ç¡¬å›è½¦(åˆ—è¡¨æ ¼å¼)ï¼Œå…³é—­åˆ™åˆå¹¶ä¸ºä¸€æ®µ"><input type="checkbox" id="opt_keep_para_descr" checked> å¸¸è§„æè¿°</label>
                             <label title="å¼€å¯åä¿ç•™#msg/#textä¸­çš„ç¡¬å›è½¦"><input type="checkbox" id="opt_keep_para_event" checked> äº‹ä»¶æ–‡æœ¬</label>
                        </div>
                        <div style="height:1px; background:var(--border-color); margin:2px 0;"></div>
                        <label title="å³ä½¿ä¸ç¿»è¯‘ï¼Œä¹Ÿå¯¹åŸæ–‡è¿›è¡Œå¼ºåˆ¶æ¢è¡Œå¤„ç†"><input type="checkbox" id="opt_force_reformat"> å¼ºåˆ¶é‡æ’åŸæ–‡</label>
                        <label title="å¿½ç•¥é‡åæ¡ç›®"><input type="checkbox" id="opt_ignore_dupes" style="accent-color:#ff4444"> ğŸš« å¿½ç•¥é‡åæ¡ç›®</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <span class="col-title" style="text-align:center"><i class="fa-solid fa-bolt"></i> 3. æ‰§è¡Œæ“ä½œ</span>
        <button class="btn btn-purple" onclick="openAIPromptModal()"><i class="fa-solid fa-brain"></i> AI æç¤ºè¯</button>
        <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')"><i class="fa-solid fa-file-import"></i> å¯¼å…¥ç¿»è¯‘</button>
        
        <!-- Dictionary Group -->
        <div class="glossary-group">
            <button class="btn btn-teal" onclick="exportGlossary()"><i class="fa-solid fa-file-export"></i> å¯¼å‡ºè¯åº“</button>
            <input type="file" id="glossaryInput" accept=".json" style="display:none">
            <button class="btn btn-teal" onclick="document.getElementById('glossaryInput').click()"><i class="fa-solid fa-book"></i> å¯¼å…¥è¯åº“</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="btn btn-fix" onclick="autoFixSwappedNames()"><i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½ä¿®å¤</button>
            <button class="btn btn-patch" onclick="generatePatchMod()" title="ç”ŸæˆåªåŒ…å«selectæŒ‡ä»¤å’Œç¿»è¯‘çš„è¡¥ä¸Mod"><i class="fa-solid fa-bandage"></i> ç”Ÿæˆè¡¥ä¸</button>
        </div>
        <button class="btn btn-primary" onclick="generateModFile()"><i class="fa-solid fa-download"></i> ç”Ÿæˆå®Œæ•´ Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all"><i class="fa-solid fa-border-all"></i> å…¨éƒ¨</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit"><i class="fa-solid fa-chess-knight"></i> å•ä½</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell"><i class="fa-solid fa-hat-wizard"></i> æ³•æœ¯</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item"><i class="fa-solid fa-shield-halved"></i> ç‰©å“</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site"><i class="fa-solid fa-dungeon"></i> é—è¿¹</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation"><i class="fa-solid fa-flag"></i> å›½å®¶</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event"><i class="fa-solid fa-scroll"></i> äº‹ä»¶</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc"><i class="fa-solid fa-layer-group"></i> æ‚é¡¹</button>

    <div class="search-container">
        <select class="filter-select" id="langFilter" onchange="filterData()" title="ç­›é€‰çŠ¶æ€">
            <option value="all">ğŸŒ æ‰€æœ‰</option>
            <option value="has_cn">ğŸ‡¨ğŸ‡³ å«ä¸­</option>
            <option value="no_cn">â¬œ çº¯å¤–</option>
            <option value="dupes">âš ï¸ é‡å</option>
        </select>
        <i class="fa-solid fa-magnifying-glass" style="color:var(--text-dim)"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ ID / åŸæ–‡ / æŒ‡ä»¤..." oninput="filterData()">
        <div class="counter" id="rowCounter">0 / 0</div>
    </div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="80">ID / ä¸Šä¸‹æ–‡</th>
                <th width="100">æŒ‡ä»¤</th>
                <th width="40%">åŸæ–‡</th>
                <th>è¯‘æ–‡ (Auto-Height)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:60px; color:var(--text-dim);"><i class="fa-solid fa-cloud-arrow-up" style="font-size:40px; margin-bottom:10px;"></i><br>è¯·ä¸Šä¼  .dm æ–‡ä»¶å¼€å§‹å·¥ä½œ...</td></tr>
        </tbody>
    </table>
</div>

<div class="pagination-bar">
    <div class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ (0 æ¡)</div>
    <div class="page-ctrls">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">â—€ ä¸Šä¸€é¡µ</button>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">ä¸‹ä¸€é¡µ â–¶</button>
    </div>
</div>

<!-- Modals -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--text-main)"><span><i class="fa-solid fa-robot"></i> AI æç¤ºè¯ç”Ÿæˆ</span><span id="aiCount" style="font-size:12px; color:var(--text-dim); font-weight:normal;"></span></h3>
        <div class="scope-options">
            <span style="color:var(--text-dim); font-size:12px; font-weight:bold; align-self:center;">èŒƒå›´ï¼š</span>
            <label><input type="radio" name="aiScope" value="all" checked onchange="regenerateAIPrompt()"> å¯¼å‡ºæ‰€æœ‰æœªç¿»è¯‘</label>
            <label><input type="radio" name="aiScope" value="filtered" onchange="regenerateAIPrompt()"> ä»…å½“å‰ç­›é€‰</label>
        </div>
        <textarea id="aiPromptText" style="height:300px; color:var(--text-main); border-color:var(--gold-dim);" readonly></textarea>
        <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-purple" onclick="copyAIPrompt()"><i class="fa-regular fa-copy"></i> å¤åˆ¶å†…å®¹</button>
            <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">å…³é—­</button>
        </div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold-primary);"><i class="fa-solid fa-paste"></i> å¯¼å…¥ç¿»è¯‘ç»“æœ</h3>
        <textarea id="pasteArea" style="height:350px;" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ AI è¿”å›çš„å†…å®¹ (Ctrl+V)..."></textarea>
        <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-primary" onclick="processImport()"><i class="fa-solid fa-check"></i> ç¡®è®¤å¯¼å…¥</button>
            <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">å…³é—­</button>
        </div>
    </div>
</div>

<div id="toast"><i class="fa-solid fa-circle-info"></i> <span>Ready</span></div>

<script>
    // --- Theme Logic ---
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        document.querySelector('.theme-toggle i').className = next === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        localStorage.setItem('domod_theme', next);
    }
    if(localStorage.getItem('domod_theme') === 'light') toggleTheme();

    // --- Core Logic ---
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n";
    let currentFilter = 'all', currentPage = 1, filteredIndices = [];
    const itemsPerPage = 100;
    const cnRegex = /[\u4e00-\u9fa5]/;

    const typeMap = {
        '#newmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'}, '#selectweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'},
        '#newarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'}, '#selectarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'},
        '#newitem': {cat:'item', l:'å®ç‰©', c:'bg-item'}, '#selectitem': {cat:'item', l:'å®ç‰©', c:'bg-item'},
        '#newspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'},
        '#newsite': {cat:'site', l:'é—è¿¹', c:'bg-site'}, '#selectsite': {cat:'site', l:'é—è¿¹', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'å›½å®¶', c:'bg-nation'},
        '#newevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'}, '#selectevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'},
    };
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief', '#epithet'];
    const noReplaceCmds = targetCmds; 
    
    // Patch Command Mapping
    const patchCmdMap = {
        '#newmonster': '#selectmonster', '#selectmonster': '#selectmonster',
        '#newweapon': '#selectweapon', '#selectweapon': '#selectweapon',
        '#newarmor': '#selectarmor', '#selectarmor': '#selectarmor',
        '#newitem': '#selectitem', '#selectitem': '#selectitem',
        '#newspell': '#selectspell', '#selectspell': '#selectspell',
        '#newsite': '#selectsite', '#selectsite': '#selectsite',
        '#selectnation': '#selectnation'
    };

    // --- Helpers ---
    function toggleSyncMatrix(el) {
        document.querySelectorAll('.sync-item input').forEach(b => b.checked = el.checked);
    }

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, document.getElementById('encodingSelect').value);
    });

    // --- Glossary Logic ---
    document.getElementById('glossaryInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = function(e) {
            try {
                const glossary = JSON.parse(e.target.result);
                let count = 0;
                extractedData.forEach(d => {
                    if (!d.trans && glossary[d.orig]) {
                        d.trans = glossary[d.orig];
                        count++;
                    }
                });
                showToast(`å·²ä»è¯åº“å¯¼å…¥ ${count} æ¡ç¿»è¯‘`);
                filterData();
            } catch(err) {
                alert("è¯åº“æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼");
            }
        };
        r.readAsText(f, 'UTF-8');
    });

    function exportGlossary() {
        if(!extractedData.length) return showToast("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
        let glossary = {};
        let count = 0;
        extractedData.forEach(d => {
            if(d.trans && d.trans.trim() !== "") {
                glossary[d.orig] = d.trans;
                count++;
            }
        });
        
        if(count === 0) return showToast("å½“å‰æ²¡æœ‰ä»»ä½•ç¿»è¯‘å†…å®¹");

        const jsonStr = JSON.stringify(glossary, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Dom6_Glossary_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        showToast(`å·²å¯¼å‡ºè¯åº“ï¼ŒåŒ…å« ${count} æ¡ç›®`);
    }

    // --- Parser ---
    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        // Pass 1: Global Indexing
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;
            const match = line.match(/^#\w+\s+"(.*)"/);
            if (match) {
                const cmd = line.split(' ')[0];
                if (['#descr','#description','#msg','#text','#summary','#brief'].includes(cmd)) continue;
                const lowerKey = match[1].toLowerCase();
                nameFrequency[lowerKey] = (nameFrequency[lowerKey] || 0) + 1;
            }
        }

        let ctxCmd = "Global", ctxId = "";
        
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;

            // Robust split for command and ID
            const parts = line.split(/\s+/);
            const currentCmd = parts[0];

            if (currentCmd.startsWith('#new') || currentCmd.startsWith('#select') || typeMap[currentCmd]) {
                ctxCmd = currentCmd;
                if (parts.length > 1 && /^-?\d+$/.test(parts[1])) {
                    ctxId = parts[1];
                } else {
                    ctxId = ""; 
                }
            }

            const cmdMatch = line.match(/^(#\w+)\s+"(.*)/); 
            if (cmdMatch) {
                let cmd = cmdMatch[1], potentialContent = cmdMatch[2];
                let endQuoteIdx = potentialContent.lastIndexOf('"');
                let fullContent = "", startLine = i, endLine = i;

                if (endQuoteIdx !== -1 && endQuoteIdx === potentialContent.length - 1) {
                    fullContent = potentialContent.substring(0, endQuoteIdx);
                } else {
                    if (potentialContent.indexOf('"') !== -1) {
                         fullContent = potentialContent.substring(0, potentialContent.indexOf('"'));
                    } else {
                        let buffer = potentialContent;
                        let j = i + 1;
                        while (j < originalLines.length) {
                            let nextLine = originalLines[j];
                            let closeQuote = nextLine.indexOf('"');
                            if (closeQuote !== -1) {
                                buffer += "\n" + nextLine.substring(0, closeQuote);
                                endLine = j; i = j; break;
                            } else { buffer += "\n" + nextLine; }
                            j++;
                        }
                        fullContent = buffer;
                    }
                }

                if (targetCmds.includes(cmd)) {
                    const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'æ‚é¡¹', c:'bg-misc'};
                    let cmdType = 'other';
                    if(['#name','#landname','#itemname','#modname','#epithet'].includes(cmd)) cmdType = 'name';
                    else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                    const isDupe = nameFrequency[fullContent.toLowerCase()] > 1;
                    extractedData.push({
                        startLine, endLine, id: extractedData.length,
                        type: typeInfo, cmdType, ctxId, ctxCmd, cmd, orig: fullContent, trans: "",
                        isDupe: isDupe
                    });
                }
            }
        }
        setFilter('all');
        showToast(`åŠ è½½æˆåŠŸï¼š${extractedData.length} æ¡æ•°æ®`);
    }

    function autoFixSwappedNames() {
        if(!extractedData.length) return showToast("æ²¡æœ‰æ•°æ®");
        let groups = {}, fixCount = 0;
        extractedData.forEach(d => {
            if(!d.ctxId) return; 
            let key = d.type.cat + "_" + d.ctxId;
            if(!groups[key]) groups[key] = [];
            groups[key].push(d);
        });

        for (let key in groups) {
            let items = groups[key];
            let nameItem = items.find(i => i.cmdType === 'name' && i.trans.length > 0);
            let descrItem = items.find(i => i.cmdType === 'descr' && i.trans.length > 0);
            if (nameItem && descrItem) {
                if (nameItem.trans.length > 30 && descrItem.trans.length < 20) {
                    let temp = nameItem.trans; nameItem.trans = descrItem.trans; descrItem.trans = temp;
                    fixCount++;
                }
            }
        }
        if(fixCount > 0) { showToast(`å·²æ™ºèƒ½ä¿®å¤ ${fixCount} å¤„é”™ä½ï¼`); renderTable(); } else { showToast("æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„é”™ä½"); }
    }

    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        filterData();
    }

    function filterData() {
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        const langFilter = document.getElementById('langFilter').value;

        filteredIndices = extractedData.map((d, idx) => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return -1;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return -1;
            }
            const textToCheck = (d.trans || "") + d.orig;
            const hasCN = cnRegex.test(textToCheck);
            if (langFilter === 'has_cn' && !hasCN) return -1;
            if (langFilter === 'no_cn' && hasCN) return -1;
            if (langFilter === 'dupes' && !d.isDupe) return -1;

            return idx;
        }).filter(idx => idx !== -1);
        
        currentPage = 1;
        const countText = document.getElementById('rowCounter');
        if (searchStr || currentFilter !== 'all' || langFilter !== 'all') {
            countText.innerText = `${filteredIndices.length} / ${extractedData.length}`;
        } else { countText.innerText = `æ€»: ${extractedData.length}`; }
        
        renderTable();
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredIndices.length / itemsPerPage) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) { currentPage = newPage; renderTable(); }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const totalItems = filteredIndices.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage) || 1;
        document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} / ${maxPage} é¡µ (æ€»è®¡: ${totalItems})`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === maxPage || totalItems === 0;
        
        if (totalItems === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--text-dim);">æ— åŒ¹é…æ•°æ®</td></tr>'; return; }

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const pageIndices = filteredIndices.slice(start, end);

        let html = "";
        pageIndices.forEach(idx => {
            const d = extractedData[idx];
            const warn = d.isDupe ? `<span class="alert-dupe" title="é‡åå¼•ç”¨"><i class="fa-solid fa-triangle-exclamation"></i> å¼•ç”¨</span>` : '';
            let displayOrig = escapeHtml(d.orig).replace(/\n/g, '<br><span style="color:var(--gold-dim)">â†µ</span>');
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><div style="font-size:10px; color:var(--text-dim); margin-top:4px;">${d.ctxId}</div></td>
                <td style="color:var(--text-dim); font-family:monospace; font-weight:bold;">${d.cmd}</td>
                <td style="color:var(--text-dim); font-size:13px;">${warn}${displayOrig}</td>
                <td><textarea id="t_${d.id}" oninput="autoResize(this); updateTrans(${d.id}, this.value)" onfocus="autoResize(this)">${d.trans}</textarea></td>
            </tr>`;
        });
        tbody.innerHTML = html;
        setTimeout(() => {
            pageIndices.forEach(idx => {
                const el = document.getElementById(`t_${extractedData[idx].id}`);
                if(el) {
                    const origLines = extractedData[idx].orig.split(/\r\n|\r|\n/).length;
                    el.style.height = Math.max(38, origLines * 18) + 'px';
                    if(el.value) autoResize(el);
                }
            });
        }, 0);
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function updateTrans(id, val) { extractedData[id].trans = val; }

    function shouldInclude(item) {
        if (item.isDupe && document.getElementById('opt_ignore_dupes').checked) return false;
        const cat = item.type.cat;
        if (item.cmd === '#epithet') return document.getElementById('cfg_nation_epithet')?.checked || false;
        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;
        if (cfgName === undefined) return true;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    function openAIPromptModal() {
        if(!extractedData.length) return showToast("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
        document.getElementById('aiPromptModal').classList.add('active');
        regenerateAIPrompt();
    }

    function regenerateAIPrompt() {
        const scope = document.querySelector('input[name="aiScope"]:checked').value;
        const promptHeader = `ä½ æ˜¯ä¸€ä½ç²¾é€šç­–ç•¥æ¸¸æˆã€ŠDominions 6ã€‹(ç¥åŸŸ6) çš„ä¸“ä¸šæœ¬åœ°åŒ–ç¿»è¯‘ä¸“å®¶ã€‚è¯·å¸®æˆ‘å°†ä»¥ä¸‹ Mod æ–‡æœ¬ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ã€‚\nã€æ ¸å¿ƒè§„åˆ™ã€‘\n1. æ ¼å¼å¿…é¡»ä¸¥æ ¼ä¿æŒä¸å˜ï¼šæ¯è¡Œå¼€å¤´æ˜¯ {{ID:æ•°å­—}}ï¼Œåé¢ç´§è·ŸåŸæ–‡ã€‚è¯·è¾“å‡º {{ID:æ•°å­—}} åŠ ä¸Š ç¿»è¯‘åçš„æ–‡æœ¬ã€‚\n2. ç»å¯¹ä¸è¦ç¿»è¯‘ã€ä¿®æ”¹æˆ–åˆ é™¤ {{ID:xxx}} æ ‡ç­¾ã€‚\n3. è¯·ä»¥ä»£ç å—æ ¼å¼è¾“å‡ºç»“æœã€‚\n4. é‡åˆ°æ¸¸æˆæœ¯è¯­è¯·ä¿æŒä¸“ä¸šæ€§ï¼ˆå¦‚ MR=é­”æ³•æŠ—æ€§, Protection=é˜²å¾¡å€¼ï¼‰ã€‚\n5. é£æ ¼è¦æ±‚ï¼šå²è¯—æ„Ÿã€å¥‡å¹»é£æ ¼ã€ä¿¡è¾¾é›…ã€‚\n6. å¦‚æœåŸæ–‡åŒ…å«æ¢è¡Œç¬¦ï¼Œè¯·åœ¨è¯‘æ–‡ä¸­ä¹Ÿä¿æŒæ¢è¡Œã€‚\n\nã€å¾…ç¿»è¯‘å†…å®¹ã€‘ï¼š\n`;
        let content = "", count = 0;
        const iterateList = scope === 'all' ? extractedData.map((d, i) => i) : filteredIndices;
        iterateList.forEach(idx => {
            const d = extractedData[idx];
            if(shouldInclude(d) && !d.trans) { content += `{{ID:${d.id}}} ${d.orig}\n`; count++; }
        });
        if(count === 0) content = "ï¼ˆæ²¡æœ‰æ‰¾åˆ°æœªç¿»è¯‘çš„æ¡ç›®ï¼‰";
        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiCount').innerText = `å‡†å¤‡å¯¼å‡º: ${count} æ¡`;
    }

    function copyAIPrompt() { document.getElementById('aiPromptText').select(); document.execCommand('copy'); showToast("å·²å¤åˆ¶æç¤ºè¯ï¼"); }

    // --- Helper for wrapping logic ---
    function wrapText(text, limit) {
        let regex = new RegExp(`.{1,${limit}}`, 'g');
        let parts = text.match(regex);
        return parts ? parts.join('\n') : text;
    }

    // --- Patch Generation ---
    function generatePatchMod() {
        if(!extractedData.length) return showToast("æ²¡æœ‰æ•°æ®ï¼");
        
        let patchContent = `#modname "${originalFileName.replace(/_/g, ' ')} CN Patch"\n#description "Translation patch for ${originalFileName}"\n#domversion 600\n\n`;
        let patches = new Map();

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        
        // Paragraph Preservation Flags
        const keepParaDescr = document.getElementById('opt_keep_para_descr').checked;
        const keepParaEvent = document.getElementById('opt_keep_para_event').checked;

        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitEvent = parseInt(document.getElementById('limit_event').value) || 35;
        const limitOther = parseInt(document.getElementById('limit_other').value) || 42;

        extractedData.forEach(d => {
            if (!d.trans || !shouldInclude(d) || !d.ctxId) return;

            let selectCmd = patchCmdMap[d.ctxCmd];
            if (!selectCmd) return;

            let key = `${selectCmd} ${d.ctxId}`;
            if (!patches.has(key)) patches.set(key, []);

            let finalTrans = d.trans;
            if (d.cmdType === 'descr') {
                let limit = limitOther; 
                if (d.type.cat === 'nation') limit = limitNation;
                else if (d.type.cat === 'spell') limit = limitSpell;
                else if (d.type.cat === 'event') limit = limitEvent;

                let isEventText = ['#msg', '#text', '#killermsg'].includes(d.cmd);
                let keepPara = isEventText ? keepParaEvent : keepParaDescr;

                if (useAutoWrap) {
                    if (keepPara) {
                         let paragraphs = finalTrans.split(/\r?\n/);
                         finalTrans = paragraphs.map(p => wrapText(p, limit)).join('\n');
                    } else {
                         let clean = finalTrans.replace(/\r?\n/g, ' '); 
                         finalTrans = wrapText(clean, limit);
                    }
                }
            }

            patches.get(key).push(`${d.cmd} "${finalTrans}"`);
        });

        if (patches.size === 0) return showToast("æ²¡æœ‰æ‰¾åˆ°å¯ç”Ÿæˆè¡¥ä¸çš„ç¿»è¯‘å†…å®¹");

        patches.forEach((cmds, key) => {
            patchContent += `${key}\n`;
            cmds.forEach(c => patchContent += `${c}\n`);
            patchContent += `#end\n\n`;
        });

        const blob = new Blob(["\uFEFF" + patchContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_Patch.dm`;
        a.click();
        showToast(`è¡¥ä¸ç”ŸæˆæˆåŠŸï¼`);
    }

    // --- Full Mod Generation ---
    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let globalTranslationMap = {}; 

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        const useGlobalSync = document.getElementById('opt_global_sync').checked;
        const forceReformat = document.getElementById('opt_force_reformat').checked;
        
        // Preservation Flags
        const keepParaDescr = document.getElementById('opt_keep_para_descr').checked;
        const keepParaEvent = document.getElementById('opt_keep_para_event').checked;

        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitEvent = parseInt(document.getElementById('limit_event').value) || 35;
        const limitOther = parseInt(document.getElementById('limit_other').value) || 42;

        extractedData.forEach(d => {
            let textToUse = d.trans ? d.trans : (forceReformat && shouldInclude(d) ? d.orig : null);

            if (textToUse !== null && shouldInclude(d)) {
                let finalTrans = textToUse;
                
                // Smart Wrap
                if (d.cmdType === 'descr') {
                    let limit = limitOther; 
                    if (d.type.cat === 'nation') limit = limitNation;
                    else if (d.type.cat === 'spell') limit = limitSpell;
                    else if (d.type.cat === 'event') limit = limitEvent;

                    let isEventText = ['#msg', '#text', '#killermsg'].includes(d.cmd);
                    let keepPara = isEventText ? keepParaEvent : keepParaDescr;

                    if (useAutoWrap || forceReformat) {
                        if (keepPara) {
                            let paragraphs = finalTrans.split(/\r?\n/);
                            finalTrans = paragraphs.map(p => wrapText(p, limit)).join('\n');
                        } else {
                            let clean = finalTrans.replace(/\r?\n/g, ' '); 
                            finalTrans = wrapText(clean, limit);
                        }
                    }
                }

                newLines[d.startLine] = `${d.cmd} "${finalTrans}"`;
                for(let k = d.startLine + 1; k <= d.endLine; k++) { newLines[k] = "__DELETED_LINE__"; }
                modifyCount++;

                if (useGlobalSync && d.cmdType === 'name' && d.trans) {
                    let allowSync = false;
                    if (d.type.cat === 'unit' && document.getElementById('sync_unit_name').checked) allowSync = true;
                    if (d.type.cat === 'spell' && document.getElementById('sync_spell_name').checked) allowSync = true;
                    if (d.type.cat === 'item' && document.getElementById('sync_item_name').checked) allowSync = true;
                    if (d.type.cat === 'site' && document.getElementById('sync_site_name').checked) allowSync = true;
                    if (d.type.cat === 'event' && document.getElementById('sync_event_name').checked) allowSync = true;
                    if (d.type.cat === 'misc' && document.getElementById('sync_misc_name').checked) allowSync = true;
                    if (d.type.cat === 'nation') {
                        if (d.cmd === '#name' && document.getElementById('sync_nation_name').checked) allowSync = true;
                        if (d.cmd === '#epithet' && document.getElementById('sync_nation_epithet').checked) allowSync = true;
                    }
                    if (allowSync) globalTranslationMap[d.orig.toLowerCase()] = d.trans;
                }
            }
        });

        newLines = newLines.filter(l => l !== "__DELETED_LINE__");

        if (useGlobalSync && Object.keys(globalTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1], content = match[2];
                    if (!noReplaceCmds.includes(cmd) && globalTranslationMap[content.toLowerCase()]) {
                        return line.replace(`"${content}"`, `"${globalTranslationMap[content.toLowerCase()]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`ç”ŸæˆæˆåŠŸï¼`);
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const chunks = text.split(/\{\{ID[:ï¼š](\d+)\}\}/);
        let count = 0;
        for(let i=1; i<chunks.length; i+=2) {
            let id = parseInt(chunks[i]);
            let content = chunks[i+1].trim();
            content = content.replace(/```$/, "").trim();
            if(extractedData[id]) { extractedData[id].trans = content; count++; }
        }
        document.getElementById('importModal').classList.remove('active');
        showToast(`å¯¼å…¥ ${count} æ¡æ•°æ®`);
        filterData();
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(msg) { 
        const t = document.getElementById('toast'); 
        t.innerHTML = `<i class="fa-solid fa-circle-info"></i> <span>${msg}</span>`; 
        t.classList.add('show'); 
        setTimeout(() => t.classList.remove('show'), 3000); 
    }
</script>
</body>
</html>