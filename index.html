<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --panel-bg: rgba(25, 25, 25, 0.98);
            --border-color: #3a3a3a;
            --gold-primary: #c5a059;
            --gold-hover: #e6c278;
            --gold-dim: #7a6030;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            
            /* Category Colors */
            --tag-unit: #8b2e2e; --tag-spell: #6a4c93; 
            --tag-item: #b8860b; --tag-site: #2f4f4f;
            --tag-event: #2e7d32; --tag-nation: #1565c0; --tag-misc: #555;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; border: 1px solid #222; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

        body {
            background-color: var(--bg-dark);
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: var(--text-main); font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 20px; display: flex; flex-direction: column; height: 98vh; overflow: hidden;
        }

        header {
            border-bottom: 1px solid var(--gold-dim); padding-bottom: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: radial-gradient(circle at center, rgba(197, 160, 89, 0.05) 0%, transparent 80%);
        }
        .header-title h1 {
            color: var(--gold-primary); margin: 0; font-family: "Palatino Linotype", serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 1px; font-weight: normal; font-size: 24px;
        }
        .version-tag { font-size: 11px; color: var(--gold-dim); border: 1px solid var(--gold-dim); padding: 1px 5px; border-radius: 4px; vertical-align: middle; margin-left: 8px; }
        .github-link {
            text-decoration: none; color: #ccc; background: #222; border: 1px solid #444;
            padding: 8px 15px; border-radius: 20px; font-size: 14px; transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .github-link:hover { color: #fff; border-color: var(--gold-primary); background: #333; box-shadow: 0 0 10px rgba(197, 160, 89, 0.2); }

        /* Control Panel */
        .control-panel {
            background: var(--panel-bg); border: 1px solid var(--gold-dim); border-radius: 6px;
            padding: 15px; display: grid; grid-template-columns: 220px 1fr 160px; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 15px; backdrop-filter: blur(5px);
        }
        .col-title { color: var(--gold-primary); font-size: 13px; font-weight: bold; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 4px; }

        .col-file { display: flex; flex-direction: column; gap: 10px; }
        select { background: #111; color: #ddd; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; cursor: pointer; }
        select:hover { border-color: var(--gold-dim); }

        /* Config Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; border: 1px solid #333;
        }
        .config-group { display: flex; flex-direction: column; gap: 4px; }
        .head { font-size: 11px; font-weight: bold; color: #ccc; border-bottom: 1px solid #444; padding-bottom: 2px; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .head i { width: 14px; text-align: center; }

        /* Advanced Options - Redesigned */
        .advanced-container {
            grid-column: span 4; display: flex; flex-direction: column; gap: 8px;
            border-top: 1px solid #444; margin-top: 5px; padding-top: 8px;
        }
        .adv-row { display: flex; gap: 15px; }
        .adv-box {
            flex: 1; background: rgba(255,255,255,0.02); border: 1px solid #333; border-radius: 4px; padding: 8px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .adv-header { font-size: 11px; font-weight: bold; color: var(--gold-primary); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 3px; margin-bottom: 3px; }
        
        /* Sync Matrix */
        .sync-matrix { display: flex; flex-wrap: wrap; gap: 10px; }
        .sync-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #bbb; background: #111; padding: 2px 6px; border-radius: 3px; border: 1px solid #333; }
        
        label { font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #aaa; transition: 0.2s; white-space: nowrap; }
        label:hover { color: #fff; }
        input[type="checkbox"], input[type="radio"] { accent-color: var(--gold-primary); cursor: pointer; }
        input[type="number"] { background: #000; color: var(--gold-primary); border: 1px solid #555; width: 35px; text-align: center; font-weight: bold; border-radius: 3px; }

        /* Actions */
        .col-actions { display: flex; flex-direction: column; gap: 10px; justify-content: center; }
        .btn {
            background: linear-gradient(145deg, #2b2b2b, #1f1f1f); color: var(--text-main); border: 1px solid #444;
            padding: 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; 
            transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); border-color: var(--gold-dim); color: #fff; }
        .btn-primary { background: linear-gradient(135deg, #5e1111, #3b0808); color: #ffddd0; border-color: #a63434; }
        .btn-success { background: linear-gradient(135deg, #1b3a1b, #0d1f0d); border-color: #2e7d32; color: #a5d6a7; }
        .btn-purple { background: linear-gradient(135deg, #4527a0, #311b92); border-color: #7c4dff; color: #d1c4e9; }
        .btn-fix { background: linear-gradient(135deg, #e65100, #bf360c); border-color: #ff8a65; color: #fff; }

        /* Table & Filter */
        .filter-bar { display: flex; gap: 4px; padding: 0 10px; align-items: flex-end; }
        .tab-btn {
            background: #1a1a1a; border: 1px solid #333; border-bottom: none; color: #888; padding: 6px 15px; 
            cursor: pointer; font-size: 11px; font-weight: bold; border-radius: 6px 6px 0 0; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .tab-btn.active { background: var(--panel-bg); color: var(--gold-primary); border-color: var(--gold-dim); border-bottom: 1px solid var(--panel-bg); z-index: 5; padding-bottom: 8px; margin-top: -2px; }
        .tab-btn[data-cat="all"].active { border-top: 3px solid var(--gold-primary); }
        /* Add specific colors for active tabs matching root vars if needed */

        .search-container { margin-left: auto; display: flex; align-items: center; gap: 10px; background: #1a1a1a; padding: 4px 10px; border-radius: 10px 10px 0 0; border: 1px solid #333; border-bottom: none; }
        .search-input { background: transparent; border: none; color: #fff; width: 160px; font-size: 12px; outline: none; }
        .counter { font-size: 11px; color: #666; }

        .table-wrap { flex: 1; overflow-y: auto; border: 1px solid var(--gold-dim); background: var(--panel-bg); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        th { background: #111; color: var(--gold-primary); padding: 10px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #333; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #2a2a2a; vertical-align: top; word-wrap: break-word; }
        tr:hover { background: rgba(197, 160, 89, 0.05); }

        textarea { width: 98%; background: #0a0a0a; color: #e0e0e0; border: 1px solid #333; border-radius: 4px; padding: 6px; resize: vertical; font-family: inherit; min-height: 32px; overflow: hidden; }
        textarea:focus { border-color: var(--gold-primary); background: #000; outline: none; }

        .badge { padding: 1px 5px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: bold; display: inline-block; min-width: 35px; text-align: center; margin-bottom: 2px; }
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        .alert-dupe { color: #ff6b6b; border: 1px solid #ff6b6b; padding: 0 4px; border-radius: 3px; font-size: 10px; margin-right: 5px; }

        .pagination-bar { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 8px 20px; border: 1px solid var(--gold-dim); border-top: none; border-radius: 0 0 6px 6px; }
        
        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1a1a1a; border: 1px solid var(--gold-primary); padding: 20px; width: 700px; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 15px; border-radius: 8px; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid var(--gold-primary); color: var(--gold-primary); padding: 10px 30px; opacity: 0; transition: 0.3s; z-index: 200; border-radius: 30px; font-weight: bold; pointer-events: none; }
        #toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå° <span class="version-tag">v2.8</span></h1>
    </div>
    <a href="https://github.com/Mostlai/domod_TranslationTool/tree/main" target="_blank" class="github-link"><i class="fa-brands fa-github"></i> GitHub</a>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <span class="col-title"><i class="fa-solid fa-file-code"></i> 1. æ–‡ä»¶æ“ä½œ</span>
        <select id="encodingSelect">
            <option value="UTF-8">è¯»å–ç¼–ç : UTF-8</option>
            <option value="windows-1252">è¯»å–ç¼–ç : Windows-1252</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-folder-open"></i> ä¸Šä¼  .dm æ–‡ä»¶</button>
    </div>

    <!-- 2. Config -->
    <div class="col-config" style="grid-column: span 1;">
        <span class="col-title"><i class="fa-solid fa-sliders"></i> 2. ç¿»è¯‘èŒƒå›´</span>
        <div class="config-grid">
            <div class="config-group">
                <div class="head" style="color:#ab82ff"><i class="fa-solid fa-hat-wizard"></i> æ³•æœ¯</div>
                <label><input type="checkbox" id="cfg_spell_name"> Name</label>
                <label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#ff4444"><i class="fa-solid fa-chess-knight"></i> å•ä½</div>
                <label><input type="checkbox" id="cfg_unit_name"> Name</label>
                <label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#ffd700"><i class="fa-solid fa-shield-halved"></i> ç‰©å“</div>
                <label><input type="checkbox" id="cfg_item_name"> Name</label>
                <label><input type="checkbox" id="cfg_item_descr" checked> Descr</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#00ced1"><i class="fa-solid fa-dungeon"></i> é—è¿¹</div>
                <label><input type="checkbox" id="cfg_site_name"> Name</label>
                <label><input type="checkbox" id="cfg_site_descr" checked> Descr</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#1e88e5"><i class="fa-solid fa-flag"></i> å›½å®¶</div>
                <label><input type="checkbox" id="cfg_nation_name"> Name</label>
                <label><input type="checkbox" id="cfg_nation_epithet" checked> Epithet</label>
                <label><input type="checkbox" id="cfg_nation_descr" checked> Info</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#4caf50"><i class="fa-solid fa-scroll"></i> äº‹ä»¶</div>
                <label><input type="checkbox" id="cfg_event_name"> Name</label>
                <label><input type="checkbox" id="cfg_event_descr" checked> Msg</label>
            </div>
            <div class="config-group">
                <div class="head" style="color:#ccc"><i class="fa-solid fa-layer-group"></i> æ‚é¡¹</div>
                <label><input type="checkbox" id="cfg_misc_name"> Name</label>
                <label><input type="checkbox" id="cfg_misc_descr" checked> Text</label>
            </div>

            <!-- Advanced Options -->
            <div class="advanced-container">
                <div class="adv-row">
                    <div class="adv-box" style="flex:2">
                        <div class="adv-header">
                            <span><i class="fa-solid fa-link"></i> å…¨å±€åŒæ­¥ (Global Sync) - ç»†åˆ†æ§åˆ¶</span>
                            <label style="font-weight:normal; color:#aaa"><input type="checkbox" id="opt_global_sync" checked onclick="toggleSyncMatrix(this)"> æ€»å¼€å…³</label>
                        </div>
                        <div class="sync-matrix" id="syncMatrix">
                            <!-- Dynamically generated or static -->
                            <label class="sync-item"><input type="checkbox" id="sync_unit_name" checked> å•ä½å</label>
                            <label class="sync-item"><input type="checkbox" id="sync_spell_name" checked> æ³•æœ¯å</label>
                            <label class="sync-item"><input type="checkbox" id="sync_item_name" checked> ç‰©å“å</label>
                            <label class="sync-item"><input type="checkbox" id="sync_site_name" checked> é—è¿¹å</label>
                            <label class="sync-item"><input type="checkbox" id="sync_event_name" checked> äº‹ä»¶å</label>
                            <div style="width:100%; height:1px; background:#333; margin:2px 0;"></div>
                            <label class="sync-item" style="color:#1e88e5"><input type="checkbox" id="sync_nation_name" checked> å›½å®¶å</label>
                            <label class="sync-item" style="color:#1e88e5"><input type="checkbox" id="sync_nation_epithet"> å›½å®¶ç§°å·(Epithet)</label>
                        </div>
                    </div>
                    
                    <div class="adv-box" style="flex:1">
                        <div class="adv-header"><span><i class="fa-solid fa-filter"></i> è¿‡æ»¤ä¸æ ¼å¼</span></div>
                        <label title="å¦‚æœæè¿°æ–‡æœ¬è¿‡é•¿ï¼Œå¼ºåˆ¶æ’å…¥æ¢è¡Œç¬¦"><input type="checkbox" id="opt_auto_wrap" checked style="accent-color:#ff4444"> å¼ºåˆ¶æ¢è¡Œ</label>
                        <div style="display:flex; gap:5px; flex-wrap:wrap; margin-left:18px;">
                            <label>å›½:<input type="number" id="limit_nation" value="55"></label>
                            <label>æ³•:<input type="number" id="limit_spell" value="36"></label>
                            <label>ä»–:<input type="number" id="limit_unit" value="42"></label>
                        </div>
                        <div style="margin-top:5px; border-top:1px solid #444; padding-top:5px;">
                            <label title="å³ä½¿ä¸ç¿»è¯‘ï¼Œä¹Ÿå¯¹åŸæ–‡è¿›è¡Œå¼ºåˆ¶æ¢è¡Œå¤„ç†"><input type="checkbox" id="opt_force_reformat"> å¼ºåˆ¶é‡æ’åŸæ–‡</label>
                            <label title="å‹¾é€‰åï¼ŒModä¸­é‡å¤å‡ºç°çš„Nameå°†è¢«å®Œå…¨å¿½ç•¥ï¼Œé˜²æ­¢è¯¯ç¿»å…³é”®Key"><input type="checkbox" id="opt_ignore_dupes" style="accent-color:#ff4444"> ğŸš« å¿½ç•¥é‡åæ¡ç›®</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <span class="col-title" style="text-align:center"><i class="fa-solid fa-play"></i> 3. æ‰§è¡Œ</span>
        <button class="btn btn-purple" onclick="openAIPromptModal()"><i class="fa-solid fa-brain"></i> AI æç¤ºè¯</button>
        <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')"><i class="fa-solid fa-file-import"></i> å¯¼å…¥ç¿»è¯‘</button>
        <button class="btn btn-fix" onclick="autoFixSwappedNames()"><i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½ä¿®å¤</button>
        <button class="btn btn-primary" onclick="generateModFile()"><i class="fa-solid fa-bolt"></i> ç”Ÿæˆ Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all"><i class="fa-solid fa-border-all"></i> å…¨éƒ¨</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit"><i class="fa-solid fa-chess-knight"></i> å•ä½</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell"><i class="fa-solid fa-hat-wizard"></i> æ³•æœ¯</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item"><i class="fa-solid fa-shield-halved"></i> ç‰©å“</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site"><i class="fa-solid fa-dungeon"></i> é—è¿¹</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation"><i class="fa-solid fa-flag"></i> å›½å®¶</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event"><i class="fa-solid fa-scroll"></i> äº‹ä»¶</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc"><i class="fa-solid fa-layer-group"></i> æ‚é¡¹</button>

    <div class="search-container">
        <i class="fa-solid fa-magnifying-glass" style="color:#555"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ ID / åŸæ–‡ / æŒ‡ä»¤..." oninput="filterData()">
        <div class="counter" id="rowCounter">0 / 0</div>
    </div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="80">ID</th>
                <th width="100">æŒ‡ä»¤</th>
                <th width="40%">åŸæ–‡</th>
                <th>è¯‘æ–‡ (Auto-Height)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:50px; color:#666;">è¯·ä¸Šä¼  .dm æ–‡ä»¶...</td></tr>
        </tbody>
    </table>
</div>

<div class="pagination-bar">
    <div class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ (0 æ¡)</div>
    <div class="page-ctrls">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">â—€</button>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">â–¶</button>
    </div>
</div>

<!-- Modals -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e1bee7; margin:0;">AI æç¤ºè¯ç”Ÿæˆ <span id="aiCount" style="font-size:12px; color:#aaa; font-weight:normal;"></span></h3>
        <div class="scope-options">
            <span style="color:#aaa; font-size:12px; align-self:center;">èŒƒå›´ï¼š</span>
            <label><input type="radio" name="aiScope" value="all" checked onchange="regenerateAIPrompt()"> å¯¼å‡ºæ‰€æœ‰æœªç¿»è¯‘</label>
            <label><input type="radio" name="aiScope" value="filtered" onchange="regenerateAIPrompt()"> ä»…å½“å‰ç­›é€‰</label>
        </div>
        <textarea id="aiPromptText" style="height:300px; color:#e1bee7; border-color:#7c4dff;" readonly></textarea>
        <div style="text-align:right;"><button class="btn btn-purple" onclick="copyAIPrompt()">å¤åˆ¶</button> <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold-primary); margin:0;">å¯¼å…¥ç¿»è¯‘</h3>
        <textarea id="pasteArea" style="height:350px;" placeholder="Ctrl+V ç²˜è´´..."></textarea>
        <div style="text-align:right;"><button class="btn btn-primary" onclick="processImport()">å¯¼å…¥</button> <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">å…³é—­</button></div>
    </div>
</div>

<div id="toast">Message</div>

<script>
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n";
    let currentFilter = 'all', currentPage = 1, filteredIndices = [];
    const itemsPerPage = 100;

    const typeMap = {
        '#newmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'}, '#selectweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'},
        '#newarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'}, '#selectarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'},
        '#newitem': {cat:'item', l:'å®ç‰©', c:'bg-item'}, '#selectitem': {cat:'item', l:'å®ç‰©', c:'bg-item'},
        '#newspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'},
        '#newsite': {cat:'site', l:'é—è¿¹', c:'bg-site'}, '#selectsite': {cat:'site', l:'é—è¿¹', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'å›½å®¶', c:'bg-nation'},
        '#newevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'}, '#selectevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'},
    };
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief', '#epithet'];
    const noReplaceCmds = targetCmds; 

    // Sync Toggles
    function toggleSyncMatrix(el) {
        const boxes = document.querySelectorAll('.sync-item input');
        boxes.forEach(b => b.checked = el.checked);
    }

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, document.getElementById('encodingSelect').value);
    });

    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        originalLines.forEach(l => {
            const m = l.match(/^#name\s+"([^"]*)"/); 
            if(m) nameFrequency[m[1]] = (nameFrequency[m[1]]||0)+1;
        });

        let ctxCmd = "Global", ctxId = "";
        
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;

            const parts = line.split(' ');
            if (parts[0].startsWith('#new') || parts[0].startsWith('#select') || typeMap[parts[0]]) {
                ctxCmd = parts[0];
                ctxId = parts.length > 1 ? parts[1] : "";
            }

            const cmdMatch = line.match(/^(#\w+)\s+"(.*)/); 
            if (cmdMatch) {
                let cmd = cmdMatch[1];
                let potentialContent = cmdMatch[2];
                let endQuoteIdx = potentialContent.lastIndexOf('"');
                let fullContent = "", startLine = i, endLine = i;

                if (endQuoteIdx !== -1 && endQuoteIdx === potentialContent.length - 1) {
                    fullContent = potentialContent.substring(0, endQuoteIdx);
                } else {
                    if (potentialContent.indexOf('"') !== -1) {
                         fullContent = potentialContent.substring(0, potentialContent.indexOf('"'));
                    } else {
                        let buffer = potentialContent;
                        let j = i + 1;
                        while (j < originalLines.length) {
                            let nextLine = originalLines[j];
                            let closeQuote = nextLine.indexOf('"');
                            if (closeQuote !== -1) {
                                buffer += "\n" + nextLine.substring(0, closeQuote);
                                endLine = j; i = j; break;
                            } else { buffer += "\n" + nextLine; }
                            j++;
                        }
                        fullContent = buffer;
                    }
                }

                if (targetCmds.includes(cmd)) {
                    const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'æ‚é¡¹', c:'bg-misc'};
                    let cmdType = 'other';
                    if(['#name','#landname','#itemname','#modname','#epithet'].includes(cmd)) cmdType = 'name';
                    else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                    extractedData.push({
                        startLine, endLine, id: extractedData.length,
                        type: typeInfo, cmdType, ctxId, cmd, orig: fullContent, trans: "",
                        isDupe: (cmd === '#name' && nameFrequency[fullContent] > 1)
                    });
                }
            }
        }
        setFilter('all');
        showToast(`åŠ è½½æˆåŠŸï¼š${extractedData.length} æ¡æ•°æ®`);
    }

    function autoFixSwappedNames() {
        if(!extractedData.length) return showToast("æ²¡æœ‰æ•°æ®");
        let groups = {}, fixCount = 0;
        extractedData.forEach(d => {
            if(!d.ctxId) return; 
            let key = d.type.cat + "_" + d.ctxId;
            if(!groups[key]) groups[key] = [];
            groups[key].push(d);
        });

        for (let key in groups) {
            let items = groups[key];
            let nameItem = items.find(i => i.cmdType === 'name' && i.trans.length > 0);
            let descrItem = items.find(i => i.cmdType === 'descr' && i.trans.length > 0);
            if (nameItem && descrItem) {
                if (nameItem.trans.length > 30 && descrItem.trans.length < 20) {
                    let temp = nameItem.trans; nameItem.trans = descrItem.trans; descrItem.trans = temp;
                    fixCount++;
                }
            }
        }
        if(fixCount > 0) { showToast(`å·²æ™ºèƒ½ä¿®å¤ ${fixCount} å¤„é”™ä½ï¼`); renderTable(); } else { showToast("æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„é”™ä½"); }
    }

    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        filterData();
    }

    function filterData() {
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        filteredIndices = extractedData.map((d, idx) => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return -1;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return -1;
            }
            return idx;
        }).filter(idx => idx !== -1);
        currentPage = 1;
        renderTable();
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredIndices.length / itemsPerPage) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) { currentPage = newPage; renderTable(); }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const totalItems = filteredIndices.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage) || 1;
        document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} / ${maxPage} é¡µ (å…± ${totalItems} æ¡)`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === maxPage || totalItems === 0;
        
        if (totalItems === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#666;">æ— åŒ¹é…æ•°æ®</td></tr>'; return; }

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const pageIndices = filteredIndices.slice(start, end);

        let html = "";
        pageIndices.forEach(idx => {
            const d = extractedData[idx];
            const warn = d.isDupe ? `<span class="alert-dupe">é‡å</span>` : '';
            let displayOrig = escapeHtml(d.orig).replace(/\n/g, '<br><span style="color:#444">â†µ</span>');
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><div style="font-size:10px; color:#666; margin-top:2px;">${d.ctxId}</div></td>
                <td style="color:#8abeb7; font-family:monospace; font-weight:bold;">${d.cmd}</td>
                <td style="color:#aaa; font-size:13px;">${warn}${displayOrig}</td>
                <td><textarea id="t_${d.id}" oninput="autoResize(this); updateTrans(${d.id}, this.value)" onfocus="autoResize(this)">${d.trans}</textarea></td>
            </tr>`;
        });
        tbody.innerHTML = html;
        setTimeout(() => {
            pageIndices.forEach(idx => {
                const el = document.getElementById(`t_${extractedData[idx].id}`);
                if(el) {
                    const origLines = extractedData[idx].orig.split(/\r\n|\r|\n/).length;
                    el.style.height = Math.max(38, origLines * 18) + 'px';
                    if(el.value) autoResize(el);
                }
            });
        }, 0);
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function updateTrans(id, val) { extractedData[id].trans = val; }

    function shouldInclude(item) {
        // Ignore Duplicates Filter
        if (item.isDupe && document.getElementById('opt_ignore_dupes').checked) return false;

        const cat = item.type.cat;
        if (item.cmd === '#epithet') return document.getElementById('cfg_nation_epithet')?.checked || false;
        
        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;
        if (cfgName === undefined) return true;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    function openAIPromptModal() {
        if(!extractedData.length) return showToast("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
        document.getElementById('aiPromptModal').classList.add('active');
        regenerateAIPrompt();
    }

    function regenerateAIPrompt() {
        const scope = document.querySelector('input[name="aiScope"]:checked').value;
        const promptHeader = `ä½ æ˜¯ä¸€ä½ç²¾é€šç­–ç•¥æ¸¸æˆã€ŠDominions 6ã€‹(ç¥åŸŸ6) çš„ä¸“ä¸šæœ¬åœ°åŒ–ç¿»è¯‘ä¸“å®¶ã€‚è¯·å¸®æˆ‘å°†ä»¥ä¸‹ Mod æ–‡æœ¬ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ã€‚\nã€æ ¸å¿ƒè§„åˆ™ã€‘\n1. æ ¼å¼å¿…é¡»ä¸¥æ ¼ä¿æŒä¸å˜ï¼šæ¯è¡Œå¼€å¤´æ˜¯ {{ID:æ•°å­—}}ï¼Œåé¢ç´§è·ŸåŸæ–‡ã€‚è¯·è¾“å‡º {{ID:æ•°å­—}} åŠ ä¸Š ç¿»è¯‘åçš„æ–‡æœ¬ã€‚\n2. ç»å¯¹ä¸è¦ç¿»è¯‘ã€ä¿®æ”¹æˆ–åˆ é™¤ {{ID:xxx}} æ ‡ç­¾ã€‚\n3. è¯·ä»¥ä»£ç å—æ ¼å¼è¾“å‡ºç»“æœã€‚\n4. é‡åˆ°æ¸¸æˆæœ¯è¯­è¯·ä¿æŒä¸“ä¸šæ€§ï¼ˆå¦‚ MR=é­”æ³•æŠ—æ€§, Protection=é˜²å¾¡å€¼ï¼‰ã€‚\n5. é£æ ¼è¦æ±‚ï¼šå²è¯—æ„Ÿã€å¥‡å¹»é£æ ¼ã€ä¿¡è¾¾é›…ã€‚\n6. å¦‚æœåŸæ–‡åŒ…å«æ¢è¡Œç¬¦ï¼Œè¯·åœ¨è¯‘æ–‡ä¸­ä¹Ÿä¿æŒæ¢è¡Œã€‚\n\nã€å¾…ç¿»è¯‘å†…å®¹ã€‘ï¼š\n`;
        let content = "", count = 0;
        
        const iterateList = scope === 'all' ? extractedData.map((d, i) => i) : filteredIndices;
        iterateList.forEach(idx => {
            const d = extractedData[idx];
            if(shouldInclude(d) && !d.trans) { content += `{{ID:${d.id}}} ${d.orig}\n`; count++; }
        });

        if(count === 0) content = "ï¼ˆæ²¡æœ‰æ‰¾åˆ°æœªç¿»è¯‘çš„æ¡ç›®ï¼‰";
        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiCount').innerText = `å‡†å¤‡å¯¼å‡º: ${count} æ¡`;
    }

    function copyAIPrompt() { document.getElementById('aiPromptText').select(); document.execCommand('copy'); showToast("å·²å¤åˆ¶æç¤ºè¯ï¼"); }

    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let globalTranslationMap = {}; 

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        const useGlobalSync = document.getElementById('opt_global_sync').checked;
        const forceReformat = document.getElementById('opt_force_reformat').checked;
        
        // Limits
        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitUnit = parseInt(document.getElementById('limit_unit').value) || 42;

        extractedData.forEach(d => {
            let textToUse = d.trans ? d.trans : (forceReformat && shouldInclude(d) ? d.orig : null);

            if (textToUse !== null && shouldInclude(d)) {
                let finalTrans = textToUse;
                
                // Wrap Logic
                if (d.cmdType === 'descr') {
                    let limit = 42; 
                    if (d.type.cat === 'nation') limit = limitNation;
                    else if (d.type.cat === 'spell') limit = limitSpell;
                    else limit = limitUnit;

                    if (useAutoWrap || forceReformat) {
                        let clean = finalTrans.replace(/\r?\n/g, ''); 
                        if (clean.length > limit) {
                            let regex = new RegExp(`.{1,${limit}}`, 'g');
                            let parts = clean.match(regex);
                            if(parts) finalTrans = parts.join('\n');
                        }
                    }
                }

                newLines[d.startLine] = `${d.cmd} "${finalTrans}"`;
                for(let k = d.startLine + 1; k <= d.endLine; k++) { newLines[k] = "__DELETED_LINE__"; }
                modifyCount++;

                // Global Sync Map Builder
                if (useGlobalSync && d.cmdType === 'name' && d.trans) {
                    // Check granular sync options
                    let allowSync = false;
                    if (d.type.cat === 'unit' && document.getElementById('sync_unit_name').checked) allowSync = true;
                    if (d.type.cat === 'spell' && document.getElementById('sync_spell_name').checked) allowSync = true;
                    if (d.type.cat === 'item' && document.getElementById('sync_item_name').checked) allowSync = true;
                    if (d.type.cat === 'site' && document.getElementById('sync_site_name').checked) allowSync = true;
                    if (d.type.cat === 'event' && document.getElementById('sync_event_name').checked) allowSync = true;
                    if (d.type.cat === 'nation') {
                        if (d.cmd === '#name' && document.getElementById('sync_nation_name').checked) allowSync = true;
                        if (d.cmd === '#epithet' && document.getElementById('sync_nation_epithet').checked) allowSync = true;
                    }
                    if (allowSync) globalTranslationMap[d.orig] = d.trans;
                }
            }
        });

        newLines = newLines.filter(l => l !== "__DELETED_LINE__");

        if (useGlobalSync && Object.keys(globalTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1], content = match[2];
                    if (!noReplaceCmds.includes(cmd) && globalTranslationMap[content]) {
                        return line.replace(`"${content}"`, `"${globalTranslationMap[content]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`ç”ŸæˆæˆåŠŸï¼`);
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const chunks = text.split(/\{\{ID[:ï¼š](\d+)\}\}/);
        let count = 0;
        for(let i=1; i<chunks.length; i+=2) {
            let id = parseInt(chunks[i]);
            let content = chunks[i+1].trim();
            content = content.replace(/```$/, "").trim();
            if(extractedData[id]) { extractedData[id].trans = content; count++; }
        }
        document.getElementById('importModal').classList.remove('active');
        showToast(`å¯¼å…¥ ${count} æ¡æ•°æ®`);
        filterData();
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>