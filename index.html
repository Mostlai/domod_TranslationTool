<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå°</title>
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --panel-bg: rgba(25, 25, 25, 0.95);
            --border-color: #3a3a3a;
            --gold-primary: #c5a059;
            --gold-hover: #e6c278;
            --gold-dim: #7a6030;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            
            /* Category Colors */
            --tag-unit: #8b2e2e; --tag-spell: #6a4c93; 
            --tag-item: #b8860b; --tag-site: #2f4f4f;
            --tag-event: #2e7d32; --tag-nation: #1565c0; --tag-misc: #555;
        }

        /* --- Global Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; border: 1px solid #222; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: var(--text-main);
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column;
            height: 98vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            border-bottom: 2px solid var(--gold-dim);
            padding-bottom: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: radial-gradient(circle at center, rgba(197, 160, 89, 0.1) 0%, transparent 70%);
        }
        h1 {
            color: var(--gold-primary); margin: 0;
            font-family: "Palatino Linotype", serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 1px; font-weight: normal;
        }
        .version-tag { font-size: 12px; color: var(--gold-dim); border: 1px solid var(--gold-dim); padding: 2px 6px; border-radius: 4px; margin-left: 10px; vertical-align: middle; }

        /* --- Control Panel --- */
        .control-panel {
            background: var(--panel-bg);
            border: 1px solid var(--gold-dim);
            border-radius: 6px;
            padding: 20px;
            display: grid; grid-template-columns: 240px 1fr 180px; gap: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .col-title { color: var(--gold-primary); font-size: 13px; font-weight: bold; margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* File Inputs */
        .col-file { display: flex; flex-direction: column; gap: 12px; justify-content: start; }
        select { 
            background: #111; color: #ddd; border: 1px solid #444; 
            padding: 8px; border-radius: 4px; width: 100%; outline: none; cursor: pointer; transition: 0.2s;
        }
        select:hover { border-color: var(--gold-dim); }

        /* Config Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; border: 1px solid #333;
        }
        .config-group { display: flex; flex-direction: column; gap: 6px; }
        .head { 
            font-size: 12px; font-weight: bold; color: #ccc; 
            border-bottom: 1px solid #444; padding-bottom: 4px; margin-bottom: 4px; 
            display: flex; align-items: center; gap: 6px;
        }
        
        /* Advanced Options */
        .advanced-options {
            grid-column: span 4; border-top: 1px solid #444; margin-top: 5px; padding-top: 10px;
            display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
        }
        
        label { font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #aaa; transition: 0.2s; }
        label:hover { color: #fff; }
        input[type="checkbox"], input[type="radio"] { accent-color: var(--gold-primary); cursor: pointer; }
        
        input[type="number"] { 
            background: #000; color: var(--gold-primary); border: 1px solid #555; 
            width: 40px; padding: 2px 0; text-align: center; font-weight: bold; border-radius: 3px;
        }
        input[type="number"]:focus { border-color: var(--gold-primary); outline: none; }

        /* Actions */
        .col-actions { display: flex; flex-direction: column; gap: 12px; justify-content: center; }

        /* Buttons */
        .btn {
            background: linear-gradient(145deg, #2b2b2b, #1f1f1f);
            color: var(--text-main); border: 1px solid #444;
            padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 13px;
            border-radius: 4px; transition: all 0.2s; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); border-color: var(--gold-dim); color: #fff; }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { 
            background: linear-gradient(135deg, #5e1111 0%, #3b0808 100%); 
            color: #ffddd0; border-color: #8a2be2; border-color: #a63434;
        }
        .btn-success { background: linear-gradient(135deg, #1b3a1b 0%, #0d1f0d 100%); border-color: #2e7d32; color: #a5d6a7; }
        .btn-purple { background: linear-gradient(135deg, #4527a0 0%, #311b92 100%); border-color: #7c4dff; color: #d1c4e9; }
        .btn-fix { background: linear-gradient(135deg, #e65100 0%, #bf360c 100%); border-color: #ff8a65; color: #fff; }

        /* --- Filter Bar --- */
        .filter-bar {
            display: flex; gap: 4px; margin-bottom: 0; 
            padding: 0 10px; border-bottom: none;
            align-items: flex-end;
        }
        
        .tab-btn {
            background: #1a1a1a; border: 1px solid #333; border-bottom: none;
            color: #888; padding: 8px 20px; cursor: pointer; font-size: 12px; font-weight: bold;
            border-radius: 6px 6px 0 0; transition: 0.2s; position: relative; top: 1px;
        }
        .tab-btn:hover { background: #252525; color: #ddd; }
        .tab-btn.active { 
            background: var(--panel-bg); color: var(--gold-primary); 
            border-color: var(--gold-dim); border-bottom: 1px solid var(--panel-bg); 
            z-index: 5; padding-bottom: 10px; margin-top: -2px;
        }
        
        .tab-btn[data-cat="all"].active { border-top: 3px solid var(--gold-primary); }
        .tab-btn[data-cat="unit"].active { border-top: 3px solid var(--tag-unit); }
        .tab-btn[data-cat="spell"].active { border-top: 3px solid var(--tag-spell); }
        .tab-btn[data-cat="item"].active { border-top: 3px solid var(--tag-item); }
        .tab-btn[data-cat="site"].active { border-top: 3px solid var(--tag-site); }
        .tab-btn[data-cat="nation"].active { border-top: 3px solid var(--tag-nation); }
        .tab-btn[data-cat="event"].active { border-top: 3px solid var(--tag-event); }
        .tab-btn[data-cat="misc"].active { border-top: 3px solid var(--tag-misc); }

        .search-container {
            margin-left: auto; display: flex; align-items: center; gap: 10px; background: #1a1a1a;
            padding: 5px 10px; border-radius: 20px 20px 0 0; border: 1px solid #333; border-bottom: none;
        }
        .search-input {
            background: transparent; border: none; color: #fff;
            width: 180px; font-size: 13px; outline: none; transition: 0.3s;
        }
        .search-input:focus { width: 240px; }
        .search-input::placeholder { color: #555; }
        .counter { font-size: 11px; color: #666; white-space: nowrap;}

        /* --- Table --- */
        .table-wrap { 
            flex: 1; overflow-y: auto; 
            border: 1px solid var(--gold-dim); 
            background: var(--panel-bg); 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        
        th { 
            background: #111; color: var(--gold-primary); padding: 12px; 
            position: sticky; top: 0; text-align: left; z-index: 10; 
            border-bottom: 2px solid #333; font-family: "Palatino Linotype", serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        td { padding: 10px 12px; border-bottom: 1px solid #2a2a2a; vertical-align: top; line-height: 1.5; word-wrap: break-word;}
        tr:nth-child(even) { background: rgba(255,255,255,0.015); }
        tr:hover { background: rgba(197, 160, 89, 0.05); }

        /* Textarea Styling */
        textarea {
            width: 98%; 
            background: #0a0a0a; color: #e0e0e0;
            border: 1px solid #333; border-radius: 4px;
            padding: 8px; resize: vertical; font-family: inherit; line-height: 1.5;
            transition: all 0.2s;
            overflow: hidden; /* Hide scrollbar, use auto-resize */
            min-height: 38px;
        }
        textarea:focus { 
            border-color: var(--gold-primary); background: #000; 
            box-shadow: 0 0 8px rgba(197, 160, 89, 0.15); outline: none; 
        }

        .badge { 
            padding: 2px 6px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: bold; 
            display: inline-block; min-width: 40px; text-align: center; margin-bottom: 4px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
        }
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        
        .alert-dupe { 
            color: #ff6b6b; font-size: 11px; border: 1px solid #ff6b6b; 
            background: rgba(100,0,0,0.2); padding: 2px 6px; border-radius: 3px; 
            display: inline-block; margin-bottom: 5px;
        }

        /* --- Pagination --- */
        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #111; padding: 10px 20px; border: 1px solid var(--gold-dim); border-top: none;
            border-radius: 0 0 6px 6px;
        }
        .page-btn {
            background: #222; color: #bbb; border: 1px solid #444;
            padding: 5px 12px; cursor: pointer; font-size: 12px; border-radius: 3px;
            transition: 0.2s;
        }
        .page-btn:hover { background: #333; color: #fff; border-color: var(--gold-primary); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #333; }

        /* --- Modals --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-box { 
            background: #1a1a1a; border: 1px solid var(--gold-primary); 
            padding: 25px; width: 750px; box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            display: flex; flex-direction: column; gap: 15px; border-radius: 8px;
        }
        
        .scope-options { 
            display: flex; gap: 20px; background: rgba(0,0,0,0.3); padding: 12px; 
            border: 1px solid #333; border-radius: 4px; 
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: #222; border: 1px solid var(--gold-primary); color: var(--gold-primary);
            padding: 12px 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; 
            border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); font-weight: bold;
        }
        #toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<header>
    <h1>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå° <span class="version-tag">v2.5</span></h1>
    <div style="font-size:12px; color:#888;">å…¨å±€åŒæ­¥</div>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <span class="col-title">1. æ–‡ä»¶æ“ä½œ</span>
        <select id="encodingSelect">
            <option value="UTF-8">è¯»å–ç¼–ç : UTF-8</option>
            <option value="windows-1252">è¯»å–ç¼–ç : Windows-1252</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ä¸Šä¼  .dm æ–‡ä»¶</button>
    </div>

    <!-- 2. Config -->
    <div class="col-config" style="grid-column: span 1;">
        <span class="col-title">2. ç¿»è¯‘èŒƒå›´</span>
        <div class="config-grid">
            <!-- Spells -->
            <div class="config-group">
                <div class="head" style="color:#ab82ff"><span style="font-size:14px">ğŸ”®</span> æ³•æœ¯</div>
                <label><input type="checkbox" id="cfg_spell_name"> Name</label>
                <label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label>
            </div>
            <!-- Units -->
            <div class="config-group">
                <div class="head" style="color:#ff4444"><span style="font-size:14px">âš”ï¸</span> å•ä½</div>
                <label><input type="checkbox" id="cfg_unit_name"> Name</label>
                <label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label>
            </div>
            <!-- Items -->
            <div class="config-group">
                <div class="head" style="color:#ffd700"><span style="font-size:14px">ğŸ›¡ï¸</span> ç‰©å“</div>
                <label><input type="checkbox" id="cfg_item_name"> Name</label>
                <label><input type="checkbox" id="cfg_item_descr" checked> Descr</label>
            </div>
            <!-- Sites -->
            <div class="config-group">
                <div class="head" style="color:#00ced1"><span style="font-size:14px">ğŸ›ï¸</span> é—è¿¹</div>
                <label><input type="checkbox" id="cfg_site_name"> Name</label>
                <label><input type="checkbox" id="cfg_site_descr" checked> Descr</label>
            </div>
            <!-- Nation -->
            <div class="config-group">
                <div class="head" style="color:#1e88e5"><span style="font-size:14px">ğŸš©</span> å›½å®¶</div>
                <label><input type="checkbox" id="cfg_nation_name"> Name</label>
                <label title="æ³¨æ„ï¼šç§°å·(Epithet)ä¸å‚ä¸å…¨å±€æ›¿æ¢"><input type="checkbox" id="cfg_nation_epithet" checked> Epithet</label>
                <label><input type="checkbox" id="cfg_nation_descr" checked> Info</label>
            </div>
            <!-- Events -->
            <div class="config-group">
                <div class="head" style="color:#4caf50"><span style="font-size:14px">ğŸ“œ</span> äº‹ä»¶</div>
                <label><input type="checkbox" id="cfg_event_name"> Name</label>
                <label><input type="checkbox" id="cfg_event_descr" checked> Msg</label>
            </div>
            <!-- Misc -->
            <div class="config-group">
                <div class="head" style="color:#ccc"><span style="font-size:14px">ğŸŒ</span> æ‚é¡¹</div>
                <label><input type="checkbox" id="cfg_misc_name"> Name</label>
                <label><input type="checkbox" id="cfg_misc_descr" checked> Text</label>
            </div>

            <div class="advanced-options">
                <label title="æ¨èï¼è¦†ç›–æ‰€æœ‰æŒ‡ä»¤ä¸­çš„åŒåå¼•ç”¨ï¼ˆEpithet é™¤å¤–ï¼‰"><input type="checkbox" id="opt_global_sync" checked style="accent-color:#00e676"> <b>å¯ç”¨å…¨å±€åç§°åŒæ­¥</b></label>
                <div style="width:1px; height:15px; background:#444; margin:0 5px;"></div>
                <label title="ä»…é’ˆå¯¹ Descr/Msg ç­‰é•¿æ–‡æœ¬ï¼Œæ¯éš”Nä¸ªå­—å¼ºåˆ¶æ’å…¥æ¢è¡Œç¬¦(\n)"><input type="checkbox" id="opt_auto_wrap" checked style="accent-color:#ff4444"> <b>å¼ºåˆ¶æ¢è¡Œ: æ¯ <input type="number" id="wrap_limit" value="55"> å­—</b></label>
                <!-- Removed Anti-Clip Checkbox as per request -->
            </div>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <span class="col-title" style="text-align:center">3. æ‰§è¡Œæ“ä½œ</span>
        <button class="btn btn-purple" onclick="openAIPromptModal()">ğŸ§  AI æç¤ºè¯</button>
        <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')">ğŸ“¥ å¯¼å…¥ç¿»è¯‘</button>
        <button class="btn btn-fix" onclick="autoFixSwappedNames()">ğŸ”® æ™ºèƒ½ä¿®å¤é”™ä½</button>
        <button class="btn btn-primary" onclick="generateModFile()">âš¡ ç”Ÿæˆ Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all">å…¨éƒ¨</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit">å•ä½</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell">æ³•æœ¯</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item">ç‰©å“</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site">é—è¿¹</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation">å›½å®¶</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event">äº‹ä»¶</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc">æ‚é¡¹</button>

    <div class="search-container">
        <span style="font-size:14px;">ğŸ”</span>
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ ID / åŸæ–‡ / æŒ‡ä»¤..." oninput="filterData()">
        <div class="counter" id="rowCounter">0 / 0</div>
    </div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="80">åˆ†ç±»/ID</th>
                <th width="100">æŒ‡ä»¤</th>
                <th width="40%">åŸæ–‡</th>
                <th>è¯‘æ–‡</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:50px; color:#666;">è¯·ä¸Šä¼  .dm æ–‡ä»¶å¼€å§‹å·¥ä½œ...</td></tr>
        </tbody>
    </table>
</div>

<div class="pagination-bar">
    <div class="page-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ (0 æ¡)</div>
    <div class="page-ctrls">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">â—€ ä¸Šä¸€é¡µ</button>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">ä¸‹ä¸€é¡µ â–¶</button>
    </div>
</div>

<!-- AI Modal -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e1bee7; margin-top:0; display:flex; justify-content:space-between;">
            <span>AI æç¤ºè¯ç”Ÿæˆ</span>
            <span id="aiCount" style="font-size:12px; color:#aaa; font-weight:normal; margin-top:5px;"></span>
        </h3>
        
        <div class="scope-options">
            <span style="color:#aaa; font-size:12px; font-weight:bold; align-self:center;">å¯¼å‡ºèŒƒå›´ï¼š</span>
            <label title="å¿½ç•¥ä¸Šæ–¹æ ‡ç­¾é¡µï¼Œæ‰«ææ•´ä¸ªæ–‡ä»¶å¯¼å‡ºæ‰€æœ‰ç¬¦åˆå¤é€‰æ¡†çš„å†…å®¹"><input type="radio" name="aiScope" value="all" checked onchange="regenerateAIPrompt()"> å¯¼å‡ºæ‰€æœ‰æœªç¿»è¯‘é¡¹ (æ¨è)</label>
            <label title="åªå¯¼å‡ºå½“å‰æ ‡ç­¾é¡µå’Œæœç´¢ç»“æœ"><input type="radio" name="aiScope" value="filtered" onchange="regenerateAIPrompt()"> ä»…å¯¼å‡ºå½“å‰ç­›é€‰ç»“æœ</label>
        </div>

        <p style="font-size:12px; color:#aaa; margin:0 0 5px 0;">
            æç¤ºï¼šå¦‚æœæ€»æ¡ç›®è¿‡å¤š (>1500æ¡)ï¼Œå»ºè®®ä½¿ç”¨â€œç­›é€‰â€æ¨¡å¼åˆ†æ‰¹å¯¼å‡ºï¼Œé˜²æ­¢ AI ä¸Šä¸‹æ–‡æº¢å‡ºã€‚
        </p>
        <textarea id="aiPromptText" style="height:300px; font-family:monospace; color:#e1bee7; border-color:#7c4dff;" readonly></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">å…³é—­</button>
            <button class="btn btn-purple" onclick="copyAIPrompt()">å¤åˆ¶</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold-primary); margin-top:0;">å¯¼å…¥ç¿»è¯‘ç»“æœ</h3>
        <textarea id="pasteArea" style="height:350px; font-family:monospace;" placeholder="Ctrl+V ç²˜è´´..."></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">å…³é—­</button>
            <button class="btn btn-primary" onclick="processImport()">ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<div id="toast">Ready</div>

<script>
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n";
    let currentFilter = 'all', currentPage = 1;
    const itemsPerPage = 100;
    let filteredIndices = [];

    const typeMap = {
        '#newmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'}, '#selectweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'},
        '#newarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'}, '#selectarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'},
        '#newitem': {cat:'item', l:'å®ç‰©', c:'bg-item'}, '#selectitem': {cat:'item', l:'å®ç‰©', c:'bg-item'},
        '#newspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'},
        '#newsite': {cat:'site', l:'é—è¿¹', c:'bg-site'}, '#selectsite': {cat:'site', l:'é—è¿¹', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'å›½å®¶', c:'bg-nation'},
        '#newevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'}, '#selectevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'},
    };
    
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief', '#epithet'];
    const noReplaceCmds = targetCmds; 

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const encoding = document.getElementById('encodingSelect').value;
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, encoding);
    });

    // --- Parser (Multi-line) ---
    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        originalLines.forEach(l => {
            const m = l.match(/^#name\s+"([^"]*)"/); 
            if(m) nameFrequency[m[1]] = (nameFrequency[m[1]]||0)+1;
        });

        let ctxCmd = "Global", ctxId = "";
        
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;

            const parts = line.split(' ');
            if (parts[0].startsWith('#new') || parts[0].startsWith('#select') || typeMap[parts[0]]) {
                ctxCmd = parts[0];
                ctxId = parts.length > 1 ? parts[1] : "";
            }

            const cmdMatch = line.match(/^(#\w+)\s+"(.*)/); 
            if (cmdMatch) {
                let cmd = cmdMatch[1];
                let potentialContent = cmdMatch[2];
                let endQuoteIdx = potentialContent.lastIndexOf('"');
                let fullContent = "";
                let startLine = i;
                let endLine = i;

                if (endQuoteIdx !== -1 && endQuoteIdx === potentialContent.length - 1) {
                    fullContent = potentialContent.substring(0, endQuoteIdx);
                } else {
                    if (potentialContent.indexOf('"') !== -1) {
                         fullContent = potentialContent.substring(0, potentialContent.indexOf('"'));
                    } else {
                        let buffer = potentialContent;
                        let j = i + 1;
                        while (j < originalLines.length) {
                            let nextLine = originalLines[j];
                            let closeQuote = nextLine.indexOf('"');
                            if (closeQuote !== -1) {
                                buffer += "\n" + nextLine.substring(0, closeQuote);
                                endLine = j;
                                i = j;
                                break;
                            } else {
                                buffer += "\n" + nextLine;
                            }
                            j++;
                        }
                        fullContent = buffer;
                    }
                }

                if (targetCmds.includes(cmd)) {
                    const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'æ‚é¡¹', c:'bg-misc'};
                    let cmdType = 'other';
                    if(['#name','#landname','#itemname','#modname','#epithet'].includes(cmd)) cmdType = 'name';
                    else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                    extractedData.push({
                        startLine: startLine,
                        endLine: endLine,
                        id: extractedData.length,
                        type: typeInfo,
                        cmdType: cmdType,
                        ctxId: ctxId,
                        cmd: cmd,
                        orig: fullContent,
                        trans: "",
                        isDupe: (cmd === '#name' && nameFrequency[fullContent] > 1)
                    });
                }
            }
        }
        setFilter('all');
        showToast(`åŠ è½½æˆåŠŸï¼š${extractedData.length} æ¡æ•°æ®`);
    }

    // --- Smart Fix ---
    function autoFixSwappedNames() {
        if(!extractedData.length) return showToast("æ²¡æœ‰æ•°æ®");
        let groups = {};
        extractedData.forEach(d => {
            if(!d.ctxId) return; 
            let key = d.type.cat + "_" + d.ctxId;
            if(!groups[key]) groups[key] = [];
            groups[key].push(d);
        });

        let fixCount = 0;
        for (let key in groups) {
            let items = groups[key];
            let nameItem = items.find(i => i.cmdType === 'name' && i.trans.length > 0);
            let descrItem = items.find(i => i.cmdType === 'descr' && i.trans.length > 0);

            if (nameItem && descrItem) {
                if (nameItem.trans.length > 30 && descrItem.trans.length < 20) {
                    let temp = nameItem.trans;
                    nameItem.trans = descrItem.trans;
                    descrItem.trans = temp;
                    fixCount++;
                }
            }
        }

        if(fixCount > 0) {
            showToast(`å·²æ™ºèƒ½ä¿®å¤ ${fixCount} å¤„é”™ä½ï¼`);
            renderTable(); 
        } else {
            showToast("æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„é”™ä½");
        }
    }

    // --- Filtering & Pagination ---
    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        filterData();
    }

    function filterData() {
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        filteredIndices = extractedData.map((d, idx) => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return -1;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return -1;
            }
            return idx;
        }).filter(idx => idx !== -1);
        currentPage = 1;
        renderTable();
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredIndices.length / itemsPerPage) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) {
            currentPage = newPage;
            renderTable();
        }
    }

    // --- Render with Auto-Height Textarea ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const totalItems = filteredIndices.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage) || 1;
        
        document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} / ${maxPage} é¡µ (æ€»è®¡: ${totalItems} æ¡)`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === maxPage || totalItems === 0;
        
        if (totalItems === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#666;">æ— åŒ¹é…æ•°æ®</td></tr>'; return; }

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const pageIndices = filteredIndices.slice(start, end);

        let html = "";
        pageIndices.forEach(idx => {
            const d = extractedData[idx];
            const warn = d.isDupe ? `<span class="alert-dupe">é‡å</span>` : '';
            let displayOrig = escapeHtml(d.orig).replace(/\n/g, '<br><span style="color:#444">â†µ</span>');
            
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><div style="font-size:10px; color:#666; margin-top:2px;">${d.ctxId}</div></td>
                <td style="color:#8abeb7; font-family:monospace; font-weight:bold;">${d.cmd}</td>
                <td style="color:#aaa; font-size:13px;">${warn}${displayOrig}</td>
                <td>
                    <textarea id="t_${d.id}" 
                        oninput="autoResize(this); updateTrans(${d.id}, this.value)" 
                        onfocus="autoResize(this)"
                    >${d.trans}</textarea>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
        
        // Post-render: Auto resize all textareas to match content or original height
        setTimeout(() => {
            pageIndices.forEach(idx => {
                const el = document.getElementById(`t_${extractedData[idx].id}`);
                if(el) {
                    // Initial sizing: roughly match Original height if empty, or content height if filled
                    const origLines = extractedData[idx].orig.split(/\r\n|\r|\n/).length;
                    const minHeight = Math.max(38, origLines * 18); // Approx 18px per line
                    el.style.height = minHeight + 'px';
                    // If content exists, fit to content
                    if(el.value) autoResize(el);
                }
            });
        }, 0);
    }

    function autoResize(el) {
        el.style.height = 'auto'; 
        el.style.height = el.scrollHeight + 'px';
    }

    function updateTrans(id, val) { extractedData[id].trans = val; }

    function shouldInclude(item) {
        const cat = item.type.cat;
        
        // Epithet Check
        if (item.cmd === '#epithet') {
            return document.getElementById('cfg_nation_epithet')?.checked || false;
        }

        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;

        if (cfgName === undefined || cfgDescr === undefined) return false;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    // --- AI ---
    function openAIPromptModal() {
        if(!extractedData.length) return showToast("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
        document.getElementById('aiPromptModal').classList.add('active');
        regenerateAIPrompt();
    }

    function regenerateAIPrompt() {
        const scope = document.querySelector('input[name="aiScope"]:checked').value;
        const promptHeader = `ä½ æ˜¯ä¸€ä½ç²¾é€šç­–ç•¥æ¸¸æˆã€ŠDominions 6ã€‹(ç¥åŸŸ6) çš„ä¸“ä¸šæœ¬åœ°åŒ–ç¿»è¯‘ä¸“å®¶ã€‚è¯·å¸®æˆ‘å°†ä»¥ä¸‹ Mod æ–‡æœ¬ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ã€‚\nã€æ ¸å¿ƒè§„åˆ™ã€‘\n1. æ ¼å¼å¿…é¡»ä¸¥æ ¼ä¿æŒä¸å˜ï¼šæ¯è¡Œå¼€å¤´æ˜¯ {{ID:æ•°å­—}}ï¼Œåé¢ç´§è·ŸåŸæ–‡ã€‚è¯·è¾“å‡º {{ID:æ•°å­—}} åŠ ä¸Š ç¿»è¯‘åçš„æ–‡æœ¬ã€‚\n2. ç»å¯¹ä¸è¦ç¿»è¯‘ã€ä¿®æ”¹æˆ–åˆ é™¤ {{ID:xxx}} æ ‡ç­¾ã€‚\n3. è¯·ä»¥ä»£ç å—æ ¼å¼è¾“å‡ºç»“æœã€‚\n4. é‡åˆ°æ¸¸æˆæœ¯è¯­è¯·ä¿æŒä¸“ä¸šæ€§ï¼ˆå¦‚ MR=é­”æ³•æŠ—æ€§, Protection=é˜²å¾¡å€¼ï¼‰ã€‚\n5. é£æ ¼è¦æ±‚ï¼šå²è¯—æ„Ÿã€å¥‡å¹»é£æ ¼ã€ä¿¡è¾¾é›…ã€‚\n6. å¦‚æœåŸæ–‡åŒ…å«æ¢è¡Œç¬¦ï¼Œè¯·åœ¨è¯‘æ–‡ä¸­ä¹Ÿä¿æŒæ¢è¡Œã€‚\n\nã€å¾…ç¿»è¯‘å†…å®¹ã€‘ï¼š\n`;

        let content = "";
        let count = 0;
        
        if (scope === 'all') {
            extractedData.forEach(d => {
                if(shouldInclude(d) && !d.trans) {
                    content += `{{ID:${d.id}}} ${d.orig}\n`;
                    count++;
                }
            });
        } else {
            filteredIndices.forEach(idx => {
                const d = extractedData[idx];
                if(shouldInclude(d) && !d.trans) {
                    content += `{{ID:${d.id}}} ${d.orig}\n`;
                    count++;
                }
            });
        }

        if(count === 0) content = "ï¼ˆæ²¡æœ‰æ‰¾åˆ°æœªç¿»è¯‘çš„æ¡ç›®ï¼‰";
        
        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiCount').innerText = `å‡†å¤‡å¯¼å‡º: ${count} æ¡`;
    }

    function copyAIPrompt() {
        document.getElementById('aiPromptText').select();
        document.execCommand('copy');
        showToast("å·²å¤åˆ¶æç¤ºè¯ï¼");
    }

    // --- Generate ---
    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let globalTranslationMap = {}; 

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        const useGlobalSync = document.getElementById('opt_global_sync').checked;
        const wrapLimit = parseInt(document.getElementById('wrap_limit').value) || 55;

        extractedData.forEach(d => {
            if(d.trans && shouldInclude(d)) {
                let finalTrans = d.trans;
                
                // Force Newline Wrap
                if(useAutoWrap && d.cmdType === 'descr' && finalTrans.length > wrapLimit) {
                     let clean = finalTrans.replace(/\r?\n/g, ''); 
                     let regex = new RegExp(`.{1,${wrapLimit}}`, 'g');
                     let parts = clean.match(regex);
                     if(parts) finalTrans = parts.join('\n');
                }

                newLines[d.startLine] = `${d.cmd} "${finalTrans}"`;
                for(let k = d.startLine + 1; k <= d.endLine; k++) {
                    newLines[k] = "__DELETED_LINE__";
                }
                modifyCount++;

                // Global Sync (Excluding Epithet)
                if (d.cmdType === 'name' && d.cmd !== '#epithet' && useGlobalSync) {
                    globalTranslationMap[d.orig] = finalTrans;
                }
            }
        });

        newLines = newLines.filter(l => l !== "__DELETED_LINE__");

        if (useGlobalSync && Object.keys(globalTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1];
                    const content = match[2];
                    if (!noReplaceCmds.includes(cmd) && globalTranslationMap[content]) {
                        return line.replace(`"${content}"`, `"${globalTranslationMap[content]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`ç”ŸæˆæˆåŠŸï¼`);
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const chunks = text.split(/\{\{ID[:ï¼š](\d+)\}\}/);
        let count = 0;
        for(let i=1; i<chunks.length; i+=2) {
            let id = parseInt(chunks[i]);
            let content = chunks[i+1].trim();
            content = content.replace(/```$/, "").trim();
            if(extractedData[id]) {
                extractedData[id].trans = content;
                count++;
            }
        }
        document.getElementById('importModal').classList.remove('active');
        showToast(`å¯¼å…¥ ${count} æ¡æ•°æ®`);
        filterData();
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>