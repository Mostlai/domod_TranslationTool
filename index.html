<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dominions 6 Mod Ê±âÂåñÂ∑•‰ΩúÂè∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
            --input-bg: #0a0a0a;
            
            --gold-primary: #c5a059;
            --gold-glow: rgba(197, 160, 89, 0.2);
            --gold-dim: #7a6030;
            
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.5);
            
            /* Category Colors */
            --tag-unit: #ef5350; --tag-spell: #ab47bc; 
            --tag-item: #fdd835; --tag-site: #26a69a;
            --tag-event: #2e7d32; --tag-nation: #42a5f5; --tag-misc: #78909c;
        }

        [data-theme="light"] {
            --bg-color: #f4f6f8;
            --panel-bg: #ffffff;
            --text-main: #2c3e50;
            --text-dim: #607d8b;
            --border-color: #e0e0e0;
            --input-bg: #f0f2f5;
            --gold-primary: #a67c00; 
            --gold-glow: rgba(166, 124, 0, 0.3);
            --gold-dim: #d4a017;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.1);
            
            --tag-unit: #c62828; --tag-spell: #6a1b9a; 
            --tag-item: #fbc02d; --tag-site: #00695c;
            --tag-event: #2e7d32; --tag-nation: #1565c0; --tag-misc: #455a64;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, var(--gold-glow) 0%, transparent 70%);
            color: var(--text-main);
            font-family: "Segoe UI", "Inter", sans-serif;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            transition: background 0.3s, color 0.3s;
            box-sizing: border-box;
        }

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 8px; margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .header-left h1 {
            color: var(--gold-primary); margin: 0;
            font-family: "Palatino Linotype", serif; letter-spacing: 1px;
            text-shadow: 0 2px 10px var(--gold-glow);
            font-size: 18px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .version-tag { 
            font-size: 11px; background: var(--gold-glow); color: var(--gold-primary); 
            padding: 2px 8px; border-radius: 12px; font-weight: bold; border: 1px solid var(--gold-primary);
            margin-left: 5px; vertical-align: middle; display: inline-block;
        }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .theme-toggle { background:none; border:none; cursor:pointer; font-size:16px; color:var(--text-dim); transition:0.3s; padding: 5px; }
        .theme-toggle:hover { color:var(--gold-primary); transform: rotate(15deg); }
        .github-link {
            text-decoration: none; color: var(--text-dim); background: var(--panel-bg);
            border: 1px solid var(--border-color); padding: 4px 10px; border-radius: 20px;
            font-size: 12px; display: flex; align-items: center; gap: 5px; box-shadow: var(--shadow-soft);
            transition: 0.3s; white-space: nowrap;
        }
        .github-link:hover { color: var(--gold-primary); border-color: var(--gold-primary); transform: translateY(-2px); }

        /* --- Control Panel (Advanced Responsive) --- */
        .control-panel {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 12px; margin-bottom: 8px;
            box-shadow: var(--shadow-soft); backdrop-filter: blur(5px);
            
            display: grid; 
            gap: 12px;
            /* Desktop Default */
            grid-template-columns: 200px 1fr 160px;
            grid-template-areas: "file config actions";
            
            flex-shrink: 0; 
            transition: all 0.3s ease;
            max-height: 40vh; /* Prevent taking up too much screen on weird laptops */
            overflow-y: auto;
        }

        .col-file { grid-area: file; display: flex; flex-direction: column; gap: 8px; }
        .col-config { grid-area: config; display: flex; flex-direction: column; gap: 5px; min-width: 0; }
        .col-actions { grid-area: actions; display: flex; flex-direction: column; gap: 6px; justify-content: flex-start; }

        .col-title { 
            color: var(--gold-primary); font-size: 11px; font-weight: 700; margin-bottom: 4px; 
            display: block; text-transform: uppercase; letter-spacing: 0.5px; 
            border-bottom: 2px solid var(--border-color); padding-bottom: 2px;
        }

        /* --- Components --- */
        select, input[type="text"], input[type="number"] { 
            background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); 
            border-radius: 6px; outline: none; transition: 0.2s; max-width: 100%;
        }
        select { padding: 6px; width: 100%; cursor: pointer; font-size: 12px;}
        select:hover { border-color: var(--gold-dim); }

        .btn {
            background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color);
            padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;
            border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
            white-space: nowrap; flex: 1;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-hover); border-color: var(--gold-primary); }
        .btn-primary { background: linear-gradient(135deg, #a01a1a, #680e0e); color: white; border: none; }
        [data-theme="light"] .btn-primary { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
        .btn-success { background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white; border: none; }
        .btn-purple { background: linear-gradient(135deg, #6200ea, #311b92); color: white; border: none; }
        .btn-fix { background: linear-gradient(135deg, #ff6f00, #e65100); color: white; border: none; }
        .btn-teal { background: linear-gradient(135deg, #00838f, #006064); color: white; border: none; }
        .btn-patch { background: linear-gradient(135deg, #424242, #212121); border: 1px solid var(--gold-dim); color: var(--gold-primary); }

        /* Config Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
            background: var(--input-bg); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .config-group { display: flex; flex-direction: column; gap: 2px; }
        .head { font-size: 11px; font-weight: bold; color: var(--text-dim); border-bottom: 1px solid var(--border-color); margin-bottom: 2px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .head i { width: 14px; text-align: center; color: var(--gold-primary); font-size: 10px;}
        
        label { font-size: 11px; display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--text-dim); white-space: nowrap; }
        label:hover { color: var(--text-main); }
        input[type="checkbox"], input[type="radio"] { accent-color: var(--gold-primary); cursor: pointer; width: 12px; height: 12px; flex-shrink: 0;}

        /* Advanced Options */
        .advanced-options {
            border-top: 1px dashed var(--border-color); margin-top: 5px; padding-top: 8px;
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px;
        }
        .adv-block {
            display: flex; flex-direction: column; gap: 4px; flex: 1;
            background: var(--panel-bg); padding: 6px; border-radius: 6px; border: 1px solid var(--border-color);
            min-width: 220px;
        }
        .adv-title { font-size: 10px; color: var(--gold-primary); font-weight: 800; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; margin-bottom: 2px; }
        .sync-matrix { display: flex; flex-wrap: wrap; gap: 4px; }
        .sync-item { 
            display: flex; align-items: center; gap: 2px; font-size: 10px; 
            background: var(--input-bg); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border-color);
            color: var(--text-dim);
        }
        input[type="number"] { width: 35px; padding: 1px; text-align: center; font-size: 11px; font-weight: bold; background: var(--input-bg); border: 1px solid var(--border-color); color:var(--gold-primary); border-radius:3px; }

        /* Filter Bar */
        .filter-bar { display: flex; gap: 4px; padding: 0 5px; align-items: flex-end; flex-shrink: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 0; margin-bottom: 0; }
        .filter-bar::-webkit-scrollbar { height: 4px; }
        .filter-bar::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

        .tab-btn {
            background: var(--input-bg); border: 1px solid var(--border-color); border-bottom: none;
            color: var(--text-dim); padding: 6px 12px; cursor: pointer; font-size: 11px; font-weight: bold;
            border-radius: 6px 6px 0 0; transition: 0.2s; display: flex; align-items: center; gap: 5px; white-space: nowrap;
        }
        .tab-btn:hover { background: var(--panel-bg); color: var(--text-main); }
        .tab-btn.active { 
            background: var(--panel-bg); color: var(--gold-primary); 
            border-top: 3px solid var(--gold-primary); border-bottom: 1px solid var(--panel-bg); 
            z-index: 5; padding-bottom: 8px; margin-top: -2px;
        }
        /* Active borders */
        .tab-btn[data-cat="unit"].active { border-top-color: var(--tag-unit); color: var(--tag-unit); }
        .tab-btn[data-cat="spell"].active { border-top-color: var(--tag-spell); color: var(--tag-spell); }
        .tab-btn[data-cat="item"].active { border-top-color: var(--tag-item); color: var(--tag-item); }
        .tab-btn[data-cat="site"].active { border-top-color: var(--tag-site); color: var(--tag-site); }
        .tab-btn[data-cat="nation"].active { border-top-color: var(--tag-nation); color: var(--tag-nation); }
        .tab-btn[data-cat="event"].active { border-top-color: var(--tag-event); color: var(--tag-event); }
        .tab-btn[data-cat="misc"].active { border-top-color: var(--tag-misc); color: var(--tag-misc); }

        .search-container {
            margin-left: auto; display: flex; align-items: center; gap: 6px; 
            background: var(--input-bg); padding: 4px 10px; 
            border-radius: 12px 12px 0 0; border: 1px solid var(--border-color); border-bottom: none;
            flex-wrap: nowrap;
        }
        .search-input { width: 100px; font-size: 12px; border:none; background:transparent; }
        .search-input:focus { width: 140px; outline:none; }
        .filter-select { background: transparent; border: none; color: var(--text-dim); font-size: 11px; outline: none; cursor: pointer; border-right: 1px solid var(--border-color); padding-right: 6px; margin-right: 4px; width: auto; }
        .filter-select option { background: var(--input-bg); color: var(--text-main); }
        .counter { font-size: 10px; color: var(--text-dim); white-space: nowrap; }

        /* --- Table Area --- */
        .table-wrap { 
            flex: 1; /* Key for filling space */
            min-height: 0; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            background: var(--panel-bg); 
            box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column;
            position: relative;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        th { 
            background: var(--input-bg); color: var(--gold-primary); padding: 8px; 
            position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border-color); text-align: left;
            font-size: 11px;
        }
        td { padding: 6px 8px; border-bottom: 1px solid var(--border-color); vertical-align: top; color: var(--text-main); line-height: 1.4; word-wrap: break-word; }
        tr:nth-child(even) { background: rgba(128,128,128,0.02); }
        tr:hover { background: var(--gold-glow); }

        textarea {
            width: 96%; background: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--border-color); border-radius: 4px; padding: 4px;
            resize: none; font-family: inherit; line-height: 1.4; min-height: 24px; overflow: hidden; font-size: 13px;
        }
        textarea:focus { border-color: var(--gold-primary); background: var(--panel-bg); box-shadow: 0 0 0 2px var(--gold-glow); outline: none; }

        .badge { padding: 2px 4px; border-radius: 3px; font-size: 9px; color: #fff; font-weight: bold; display: inline-block; min-width: 30px; text-align: center; margin-bottom: 2px; }
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        
        .alert-dupe { color: #ff5252; background: rgba(255,82,82,0.1); border: 1px solid #ff5252; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 5px; display: inline-flex; align-items: center; gap: 3px; cursor: help;}

        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--input-bg); padding: 5px 15px; border: 1px solid var(--border-color); border-top: none;
            border-radius: 0 0 8px 8px; flex-shrink: 0;
            font-size: 11px;
        }
        .page-btn {
            background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 4px 10px; border-radius: 4px; cursor: pointer;
        }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: zoomIn 0.2s ease; }
        .modal-box { 
            background: var(--panel-bg); border: 1px solid var(--gold-dim); padding: 20px; width: 90%; max-width: 750px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); border-radius: 10px; display: flex; flex-direction: column; gap: 15px;
        }
        .scope-options { display: flex; gap: 20px; background: var(--input-bg); padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px; flex-wrap: wrap;}
        
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: var(--panel-bg); border-left: 4px solid var(--gold-primary); color: var(--text-main);
            padding: 8px 20px; opacity: 0; transition: 0.3s; z-index: 200; font-size: 12px;
            border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); font-weight: bold;
            display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        #toast.show { opacity: 1; bottom: 60px; }
        
        .glossary-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        
        /* 1. Tablet & Laptop (< 1100px) */
        @media (max-width: 1100px) {
            .control-panel {
                grid-template-columns: 1fr 1fr;
                grid-template-areas: 
                    "file actions"
                    "config config";
            }
            .config-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); }
            .col-file { flex-direction: row; align-items: flex-end; }
            .col-file > * { flex: 1; }
            .col-actions { flex-direction: row; flex-wrap: wrap; }
            .col-actions > * { flex: 1; min-width: 120px; }
            .glossary-group { min-width: 200px; }
        }

        /* 2. Mobile & Small Screens (< 700px) */
        @media (max-width: 700px) {
            body { padding: 5px; }
            header { flex-wrap: wrap; gap: 5px; }
            .header-left h1 { font-size: 16px; }
            .header-actions { margin-left: auto; }
            
            .control-panel {
                display: flex; flex-direction: column; gap: 10px; padding: 10px;
                max-height: 35vh; /* Allow more scrolling for panel on mobile */
            }
            .col-file { flex-direction: column; }
            .col-actions { flex-direction: column; }
            .col-actions > div { display: flex; gap: 5px; }
            
            .config-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* Table optimization for mobile */
            th:nth-child(1), td:nth-child(1) { display: none; } /* Hide ID */
            th:nth-child(2) { width: 40px; font-size: 9px; overflow: hidden; } /* Shrink Command Header */
            td:nth-child(2) { font-size: 9px; white-space: pre-wrap; word-break: break-all; } /* Shrink Command Body */
            
            /* Filter Bar adjustments */
            .filter-bar { padding-bottom: 5px; }
            .search-container { 
                margin-left: 0; width: 100%; border-radius: 8px; border-bottom: 1px solid var(--border-color);
                margin-top: 5px; flex: 1 0 100%; order: 10;
            }
            .filter-bar { flex-wrap: wrap; }
            .tab-btn { flex: 1; justify-content: center; padding: 6px 4px; font-size: 10px; }
            .tab-btn i { display: none; } /* Hide icons in tabs to save space */
            
            #toast { width: 80%; justify-content: center; }
        }

        /* 3. Short Vertical Screens (Weird Laptops) */
        @media (max-height: 600px) {
            header { margin-bottom: 4px; padding-bottom: 4px; }
            .control-panel { max-height: 150px; }
            .btn { padding: 4px 8px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>Dom6 Ê±âÂåñÂè∞ <span class="version-tag">v3.6</span></h1>
    </div>
    <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢Êó•Â§úÊ®°Âºè"><i class="fa-solid fa-moon"></i></button>
        <a href="https://github.com/Mostlai/domod_TranslationTool/tree/main" target="_blank" class="github-link"><i class="fa-brands fa-github"></i> GitHub</a>
    </div>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <span class="col-title"><i class="fa-solid fa-file-code"></i> Êñá‰ª∂</span>
        <select id="encodingSelect">
            <option value="UTF-8">UTF-8</option>
            <option value="windows-1252">ANSI (Êóß)</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-folder-open"></i> ‰∏ä‰º† .dm
        </button>
    </div>

    <!-- 2. Config -->
    <div class="col-config">
        <span class="col-title"><i class="fa-solid fa-sliders"></i> ÈÖçÁΩÆ</span>
        <div class="config-grid">
            <div class="config-group"><div class="head"><i class="fa-solid fa-hat-wizard"></i> Ê≥ïÊúØ</div><label><input type="checkbox" id="cfg_spell_name"> Name</label><label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-chess-knight"></i> Âçï‰Ωç</div><label><input type="checkbox" id="cfg_unit_name"> Name</label><label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-shield-halved"></i> Áâ©ÂìÅ</div><label><input type="checkbox" id="cfg_item_name"> Name</label><label><input type="checkbox" id="cfg_item_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-dungeon"></i> ÈÅóËøπ</div><label><input type="checkbox" id="cfg_site_name"> Name</label><label><input type="checkbox" id="cfg_site_descr" checked> Descr</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-flag"></i> ÂõΩÂÆ∂</div><label><input type="checkbox" id="cfg_nation_name"> Name</label><label><input type="checkbox" id="cfg_nation_epithet" checked> Epithet</label><label><input type="checkbox" id="cfg_nation_descr" checked> Info</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-scroll"></i> ‰∫ã‰ª∂</div><label><input type="checkbox" id="cfg_event_name"> Name</label><label><input type="checkbox" id="cfg_event_descr" checked> Msg</label></div>
            <div class="config-group"><div class="head"><i class="fa-solid fa-layer-group"></i> ÊùÇÈ°π</div><label><input type="checkbox" id="cfg_misc_name"> Name</label><label><input type="checkbox" id="cfg_misc_descr" checked> Text</label></div>
            
            <!-- Advanced Options -->
            <div class="advanced-options">
                <div class="adv-block">
                    <div class="adv-title">
                        <span><i class="fa-solid fa-link"></i> ÂÖ®Â±ÄÂêåÊ≠•</span>
                        <label style="font-weight:normal; margin:0;"><input type="checkbox" id="opt_global_sync" checked onclick="toggleSyncMatrix(this)"> ÊÄªÂºÄÂÖ≥</label>
                    </div>
                    <div class="sync-matrix">
                        <label class="sync-item"><input type="checkbox" id="sync_unit_name" checked> Âçï‰Ωç</label>
                        <label class="sync-item"><input type="checkbox" id="sync_spell_name" checked> Ê≥ïÊúØ</label>
                        <label class="sync-item"><input type="checkbox" id="sync_item_name" checked> Áâ©ÂìÅ</label>
                        <label class="sync-item"><input type="checkbox" id="sync_site_name" checked> ÈÅóËøπ</label>
                        <label class="sync-item"><input type="checkbox" id="sync_event_name" checked> ‰∫ã‰ª∂</label>
                        <label class="sync-item"><input type="checkbox" id="sync_misc_name" checked> ÊùÇÈ°π</label>
                        <label class="sync-item" style="color:var(--tag-nation)"><input type="checkbox" id="sync_nation_name" checked> ÂõΩÂÆ∂</label>
                        <label class="sync-item" style="color:var(--tag-nation)"><input type="checkbox" id="sync_nation_epithet"> Áß∞Âè∑</label>
                    </div>
                </div>
                <div class="adv-block">
                    <div class="adv-title">
                        <span><i class="fa-solid fa-align-left"></i> Ê†ºÂºè‰∏éËøáÊª§</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px; flex-wrap:wrap;">
                        <input type="checkbox" id="opt_auto_wrap" checked style="accent-color:#ff4444">
                        <span style="font-size:11px; color:var(--text-dim)">Âº∫Âà∂Êç¢Ë°å:</span>
                        <label title="ÂõΩÂÆ∂Info/Brief">ÂõΩ:<input type="number" id="limit_nation" value="55"></label>
                        <label title="Ê≥ïÊúØDescr">Ê≥ï:<input type="number" id="limit_spell" value="36"></label>
                        <label title="‰∫ã‰ª∂Msg">‰∫ã:<input type="number" id="limit_event" value="35"></label>
                        <label title="Áâ©ÂìÅDescr">Áâ©:<input type="number" id="limit_item" value="30"></label>
                        <label title="Âçï‰Ωç/ÂÖ∂‰ªñ">‰ªñ:<input type="number" id="limit_other" value="42"></label>
                    </div>
                    <div style="border-top:1px solid var(--border-color); padding-top:4px; display:flex; flex-direction:column; gap:2px;">
                        <div style="display:flex; gap:10px;">
                             <label title="‰øùÁïô#descr‰∏≠ÁöÑÁ°¨ÂõûËΩ¶"><input type="checkbox" id="opt_keep_para_descr" checked> ‰øùÁïôÊÆµËêΩ(Â∏∏)</label>
                             <label title="‰øùÁïô#msg/#text‰∏≠ÁöÑÁ°¨ÂõûËΩ¶"><input type="checkbox" id="opt_keep_para_event" checked> ‰øùÁïôÊÆµËêΩ(‰∫ã)</label>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:2px;">
                            <label title="Âº∫Âà∂ÈáçÊéí"><input type="checkbox" id="opt_force_reformat"> Âº∫Âà∂ÈáçÊéí</label>
                            <label title="ÂøΩÁï•ÈáçÂêçÊù°ÁõÆ"><input type="checkbox" id="opt_ignore_dupes" style="accent-color:#ff4444"> üö´ ÂøΩÁï•ÈáçÂêç</label>
                            <label title="ÂøΩÁï•[]ÂÜÖÂÆπ"><input type="checkbox" id="opt_ignore_brackets"> üö´ ÂøΩÁï•[]</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <span class="col-title" style="text-align:center"><i class="fa-solid fa-bolt"></i> Êìç‰Ωú</span>
        <div style="display:flex; gap:5px; width:100%;">
            <button class="btn btn-purple" onclick="openAIPromptModal()"><i class="fa-solid fa-brain"></i> AI</button>
            <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')"><i class="fa-solid fa-file-import"></i> ÂØºÂÖ•</button>
        </div>
        
        <div class="glossary-group">
            <button class="btn btn-teal" onclick="exportGlossary()"><i class="fa-solid fa-file-export"></i> ÂØºËØçÂ∫ì</button>
            <input type="file" id="glossaryInput" accept=".json" style="display:none">
            <button class="btn btn-teal" onclick="document.getElementById('glossaryInput').click()"><i class="fa-solid fa-book"></i> ÂØºËØçÂ∫ì</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; width:100%;">
            <button class="btn btn-fix" onclick="autoFixSwappedNames()"><i class="fa-solid fa-wand-magic-sparkles"></i> ‰øÆÂ§ç</button>
            <button class="btn btn-patch" onclick="generatePatchMod()" title="ÁîüÊàêË°•‰∏ÅMod"><i class="fa-solid fa-bandage"></i> Ë°•‰∏Å</button>
        </div>
        <button class="btn btn-primary" onclick="generateModFile()"><i class="fa-solid fa-download"></i> ÁîüÊàê Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all"><i class="fa-solid fa-border-all"></i> ÂÖ®ÈÉ®</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit"><i class="fa-solid fa-chess-knight"></i> Âçï‰Ωç</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell"><i class="fa-solid fa-hat-wizard"></i> Ê≥ïÊúØ</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item"><i class="fa-solid fa-shield-halved"></i> Áâ©ÂìÅ</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site"><i class="fa-solid fa-dungeon"></i> ÈÅóËøπ</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation"><i class="fa-solid fa-flag"></i> ÂõΩÂÆ∂</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event"><i class="fa-solid fa-scroll"></i> ‰∫ã‰ª∂</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc"><i class="fa-solid fa-layer-group"></i> ÊùÇÈ°π</button>

    <div class="search-container">
        <select class="filter-select" id="langFilter" onchange="filterData()" title="Á≠õÈÄâÁä∂ÊÄÅ">
            <option value="all">üåê ÂÖ®</option>
            <option value="has_cn">üá®üá≥ ‰∏≠</option>
            <option value="no_cn">‚¨ú Â§ñ</option>
            <option value="dupes">‚ö†Ô∏è Èáç</option>
        </select>
        <i class="fa-solid fa-magnifying-glass" style="color:var(--text-dim)"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢..." oninput="filterData()">
        <div class="counter" id="rowCounter">0 / 0</div>
    </div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="60">ID</th>
                <th width="80">Êåá‰ª§</th>
                <th width="40%">ÂéüÊñá</th>
                <th>ËØëÊñá</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:60px; color:var(--text-dim);"><i class="fa-solid fa-cloud-arrow-up" style="font-size:40px; margin-bottom:10px;"></i><br>ËØ∑‰∏ä‰º† .dm Êñá‰ª∂</td></tr>
        </tbody>
    </table>
</div>

<div class="pagination-bar">
    <div class="page-info" id="pageInfo">1 / 1 (0)</div>
    <div class="page-ctrls">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">‚óÄ</button>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">‚ñ∂</button>
    </div>
</div>

<!-- Modals -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--text-main)"><span><i class="fa-solid fa-robot"></i> AI ÊèêÁ§∫ËØç</span><span id="aiCount" style="font-size:12px; color:var(--text-dim); font-weight:normal;"></span></h3>
        <div class="scope-options">
            <span style="color:var(--text-dim); font-size:12px; font-weight:bold; align-self:center;">ËåÉÂõ¥Ôºö</span>
            <label><input type="radio" name="aiScope" value="all" checked onchange="regenerateAIPrompt()"> ÊâÄÊúâÊú™Áøª</label>
            <label><input type="radio" name="aiScope" value="filtered" onchange="regenerateAIPrompt()"> ‰ªÖÂΩìÂâç</label>
        </div>
        <textarea id="aiPromptText" style="height:300px; color:var(--text-main); border-color:var(--gold-dim);" readonly></textarea>
        <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-purple" onclick="copyAIPrompt()"><i class="fa-regular fa-copy"></i> Â§çÂà∂</button>
            <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold-primary);"><i class="fa-solid fa-paste"></i> ÂØºÂÖ•ÁøªËØë</h3>
        <textarea id="pasteArea" style="height:350px;" placeholder="Á≤òË¥¥ AI ÂÜÖÂÆπ..."></textarea>
        <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-primary" onclick="processImport()"><i class="fa-solid fa-check"></i> Á°ÆËÆ§</button>
            <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<div id="toast"><i class="fa-solid fa-circle-info"></i> <span>Ready</span></div>

<script>
    // --- Theme Logic ---
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        document.querySelector('.theme-toggle i').className = next === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        localStorage.setItem('domod_theme', next);
    }
    if(localStorage.getItem('domod_theme') === 'light') toggleTheme();

    // --- Core Logic ---
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n";
    let currentFilter = 'all', currentPage = 1, filteredIndices = [];
    const itemsPerPage = 100;
    const cnRegex = /[\u4e00-\u9fa5]/;

    const typeMap = {
        '#newmonster': {cat:'unit', l:'Âçï‰Ωç', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'Âçï‰Ωç', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'Ê≠¶Âô®', c:'bg-item'}, '#selectweapon': {cat:'item', l:'Ê≠¶Âô®', c:'bg-item'},
        '#newarmor': {cat:'item', l:'Èò≤ÂÖ∑', c:'bg-item'}, '#selectarmor': {cat:'item', l:'Èò≤ÂÖ∑', c:'bg-item'},
        '#newitem': {cat:'item', l:'ÂÆùÁâ©', c:'bg-item'}, '#selectitem': {cat:'item', l:'ÂÆùÁâ©', c:'bg-item'},
        '#newspell': {cat:'spell', l:'Ê≥ïÊúØ', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'Ê≥ïÊúØ', c:'bg-spell'},
        '#newsite': {cat:'site', l:'ÈÅóËøπ', c:'bg-site'}, '#selectsite': {cat:'site', l:'ÈÅóËøπ', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'ÂõΩÂÆ∂', c:'bg-nation'},
        '#newevent': {cat:'event', l:'‰∫ã‰ª∂', c:'bg-event'}, '#selectevent': {cat:'event', l:'‰∫ã‰ª∂', c:'bg-event'},
    };
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief', '#epithet'];
    const noReplaceCmds = targetCmds; 
    
    // Patch Command Mapping
    const patchCmdMap = {
        '#newmonster': '#selectmonster', '#selectmonster': '#selectmonster',
        '#newweapon': '#selectweapon', '#selectweapon': '#selectweapon',
        '#newarmor': '#selectarmor', '#selectarmor': '#selectarmor',
        '#newitem': '#selectitem', '#selectitem': '#selectitem',
        '#newspell': '#selectspell', '#selectspell': '#selectspell',
        '#newsite': '#selectsite', '#selectsite': '#selectsite',
        '#selectnation': '#selectnation'
    };

    // --- Helpers ---
    function toggleSyncMatrix(el) {
        document.querySelectorAll('.sync-item input').forEach(b => b.checked = el.checked);
    }

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, document.getElementById('encodingSelect').value);
    });

    // --- Glossary Logic ---
    document.getElementById('glossaryInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = function(e) {
            try {
                const glossary = JSON.parse(e.target.result);
                let count = 0;
                extractedData.forEach(d => {
                    if (!d.trans && glossary[d.orig]) {
                        d.trans = glossary[d.orig];
                        count++;
                    }
                });
                showToast(`Â∑≤‰ªéËØçÂ∫ìÂØºÂÖ• ${count} Êù°ÁøªËØë`);
                filterData();
            } catch(err) {
                alert("ËØçÂ∫ìÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅ");
            }
        };
        r.readAsText(f, 'UTF-8');
    });

    function exportGlossary() {
        if(!extractedData.length) return showToast("Ê≤°ÊúâÊï∞ÊçÆ");
        let glossary = {};
        let count = 0;
        extractedData.forEach(d => {
            if(d.trans && d.trans.trim() !== "") {
                glossary[d.orig] = d.trans;
                count++;
            }
        });
        if(count === 0) return showToast("Êó†ÂÜÖÂÆπÂØºÂá∫");
        const jsonStr = JSON.stringify(glossary, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Dom6_Glossary_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        showToast(`Â∑≤ÂØºÂá∫ ${count} Êù°ÁõÆ`);
    }

    // --- Parser ---
    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        // Pass 1: Global Indexing
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;
            const match = line.match(/^#\w+\s+"(.*)"/);
            if (match) {
                const cmd = line.split(' ')[0];
                if (['#descr','#description','#msg','#text','#summary','#brief'].includes(cmd)) continue;
                const lowerKey = match[1].toLowerCase();
                nameFrequency[lowerKey] = (nameFrequency[lowerKey] || 0) + 1;
            }
        }

        let ctxCmd = "Global", ctxId = "";
        
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;

            const parts = line.split(/\s+/);
            const currentCmd = parts[0];

            if (currentCmd.startsWith('#new') || currentCmd.startsWith('#select') || typeMap[currentCmd]) {
                ctxCmd = currentCmd;
                if (parts.length > 1 && /^-?\d+$/.test(parts[1])) {
                    ctxId = parts[1];
                } else {
                    ctxId = ""; 
                }
            }

            const cmdMatch = line.match(/^(#\w+)\s+"(.*)/); 
            if (cmdMatch) {
                let cmd = cmdMatch[1], potentialContent = cmdMatch[2];
                let endQuoteIdx = potentialContent.lastIndexOf('"');
                let fullContent = "", startLine = i, endLine = i;

                if (endQuoteIdx !== -1 && endQuoteIdx === potentialContent.length - 1) {
                    fullContent = potentialContent.substring(0, endQuoteIdx);
                } else {
                    if (potentialContent.indexOf('"') !== -1) {
                         fullContent = potentialContent.substring(0, potentialContent.indexOf('"'));
                    } else {
                        let buffer = potentialContent;
                        let j = i + 1;
                        while (j < originalLines.length) {
                            let nextLine = originalLines[j];
                            let closeQuote = nextLine.indexOf('"');
                            if (closeQuote !== -1) {
                                buffer += "\n" + nextLine.substring(0, closeQuote);
                                endLine = j; i = j; break;
                            } else { buffer += "\n" + nextLine; }
                            j++;
                        }
                        fullContent = buffer;
                    }
                }

                if (targetCmds.includes(cmd)) {
                    const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'ÊùÇÈ°π', c:'bg-misc'};
                    let cmdType = 'other';
                    if(['#name','#landname','#itemname','#modname','#epithet'].includes(cmd)) cmdType = 'name';
                    else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                    const isDupe = nameFrequency[fullContent.toLowerCase()] > 1;
                    extractedData.push({
                        startLine, endLine, id: extractedData.length,
                        type: typeInfo, cmdType, ctxId, ctxCmd, cmd, orig: fullContent, trans: "",
                        isDupe: isDupe
                    });
                }
            }
        }
        setFilter('all');
        showToast(`Âä†ËΩΩÊàêÂäüÔºö${extractedData.length} Êù°Êï∞ÊçÆ`);
    }

    function autoFixSwappedNames() {
        if(!extractedData.length) return showToast("Ê≤°ÊúâÊï∞ÊçÆ");
        let groups = {}, fixCount = 0;
        extractedData.forEach(d => {
            if(!d.ctxId) return; 
            let key = d.type.cat + "_" + d.ctxId;
            if(!groups[key]) groups[key] = [];
            groups[key].push(d);
        });

        for (let key in groups) {
            let items = groups[key];
            let nameItem = items.find(i => i.cmdType === 'name' && i.trans.length > 0);
            let descrItem = items.find(i => i.cmdType === 'descr' && i.trans.length > 0);
            if (nameItem && descrItem) {
                if (nameItem.trans.length > 30 && descrItem.trans.length < 20) {
                    let temp = nameItem.trans; nameItem.trans = descrItem.trans; descrItem.trans = temp;
                    fixCount++;
                }
            }
        }
        if(fixCount > 0) { showToast(`Â∑≤‰øÆÂ§ç ${fixCount} Â§ÑÈîô‰Ωç`); renderTable(); } else { showToast("Êú™Ê£ÄÊµãÂà∞ÊòéÊòæÈîô‰Ωç"); }
    }

    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        filterData();
    }

    function filterData() {
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        const langFilter = document.getElementById('langFilter').value;

        filteredIndices = extractedData.map((d, idx) => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return -1;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return -1;
            }
            const textToCheck = (d.trans || "") + d.orig;
            const hasCN = cnRegex.test(textToCheck);
            if (langFilter === 'has_cn' && !hasCN) return -1;
            if (langFilter === 'no_cn' && hasCN) return -1;
            if (langFilter === 'dupes' && !d.isDupe) return -1;

            return idx;
        }).filter(idx => idx !== -1);
        
        currentPage = 1;
        const countText = document.getElementById('rowCounter');
        if (searchStr || currentFilter !== 'all' || langFilter !== 'all') {
            countText.innerText = `${filteredIndices.length} / ${extractedData.length}`;
        } else { countText.innerText = `ÊÄª: ${extractedData.length}`; }
        
        renderTable();
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredIndices.length / itemsPerPage) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) { currentPage = newPage; renderTable(); }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const totalItems = filteredIndices.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage) || 1;
        document.getElementById('pageInfo').innerText = `Á¨¨ ${currentPage} / ${maxPage} È°µ (ÊÄª: ${totalItems})`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === maxPage || totalItems === 0;
        
        if (totalItems === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--text-dim);">Êó†ÂåπÈÖçÊï∞ÊçÆ</td></tr>'; return; }

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const pageIndices = filteredIndices.slice(start, end);

        let html = "";
        pageIndices.forEach(idx => {
            const d = extractedData[idx];
            const warn = d.isDupe ? `<span class="alert-dupe" title="ÈáçÂêç"><i class="fa-solid fa-triangle-exclamation"></i></span>` : '';
            let displayOrig = escapeHtml(d.orig).replace(/\n/g, '<br><span style="color:var(--gold-dim)">‚Üµ</span>');
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><div style="font-size:10px; color:var(--text-dim); margin-top:2px;">${d.ctxId}</div></td>
                <td style="color:var(--text-dim); font-family:monospace; font-weight:bold;">${d.cmd}</td>
                <td style="color:var(--text-dim); font-size:12px;">${warn}${displayOrig}</td>
                <td><textarea id="t_${d.id}" oninput="autoResize(this); updateTrans(${d.id}, this.value)" onfocus="autoResize(this)">${d.trans}</textarea></td>
            </tr>`;
        });
        tbody.innerHTML = html;
        setTimeout(() => {
            pageIndices.forEach(idx => {
                const el = document.getElementById(`t_${extractedData[idx].id}`);
                if(el) {
                    const origLines = extractedData[idx].orig.split(/\r\n|\r|\n/).length;
                    el.style.height = Math.max(38, origLines * 18) + 'px';
                    if(el.value) autoResize(el);
                }
            });
        }, 0);
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function updateTrans(id, val) { extractedData[id].trans = val; }

    function shouldInclude(item) {
        // Brackets Filter
        const ignoreBrackets = document.getElementById('opt_ignore_brackets').checked;
        if (ignoreBrackets && /\[.*\]/.test(item.orig)) return false;

        if (item.isDupe && document.getElementById('opt_ignore_dupes').checked) return false;
        const cat = item.type.cat;
        if (item.cmd === '#epithet') return document.getElementById('cfg_nation_epithet')?.checked || false;
        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;
        if (cfgName === undefined) return true;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    function openAIPromptModal() {
        if(!extractedData.length) return showToast("ËØ∑ÂÖà‰∏ä‰º†Êñá‰ª∂");
        document.getElementById('aiPromptModal').classList.add('active');
        regenerateAIPrompt();
    }

    function regenerateAIPrompt() {
        const scope = document.querySelector('input[name="aiScope"]:checked').value;
        const promptHeader = `‰Ω†ÊòØ‰∏Ä‰ΩçÁ≤æÈÄöÁ≠ñÁï•Ê∏∏Êàè„ÄäDominions 6„Äã(Á•ûÂüü6) ÁöÑ‰∏ì‰∏öÊú¨Âú∞ÂåñÁøªËØë‰∏ìÂÆ∂„ÄÇËØ∑Â∏ÆÊàëÂ∞Ü‰ª•‰∏ã Mod ÊñáÊú¨ÁøªËØëÊàêÁÆÄ‰Ωì‰∏≠Êñá„ÄÇ\n„ÄêÊ†∏ÂøÉËßÑÂàô„Äë\n1. Ê†ºÂºèÂøÖÈ°ª‰∏•Ê†º‰øùÊåÅ‰∏çÂèòÔºöÊØèË°åÂºÄÂ§¥ÊòØ {{ID:Êï∞Â≠ó}}ÔºåÂêéÈù¢Á¥ßË∑üÂéüÊñá„ÄÇËØ∑ËæìÂá∫ {{ID:Êï∞Â≠ó}} Âä†‰∏ä ÁøªËØëÂêéÁöÑÊñáÊú¨„ÄÇ\n2. ÁªùÂØπ‰∏çË¶ÅÁøªËØë„ÄÅ‰øÆÊîπÊàñÂà†Èô§ {{ID:xxx}} Ê†áÁ≠æ„ÄÇ\n3. ËØ∑‰ª•‰ª£Á†ÅÂùóÊ†ºÂºèËæìÂá∫ÁªìÊûú„ÄÇ\n4. ÈÅáÂà∞Ê∏∏ÊàèÊúØËØ≠ËØ∑‰øùÊåÅ‰∏ì‰∏öÊÄßÔºàÂ¶Ç MR=È≠îÊ≥ïÊäóÊÄß, Protection=Èò≤Âæ°ÂÄºÔºâ„ÄÇ\n5. È£éÊ†ºË¶ÅÊ±ÇÔºöÂè≤ËØóÊÑü„ÄÅÂ•áÂπªÈ£éÊ†º„ÄÅ‰ø°ËææÈõÖ„ÄÇ\n6. Â¶ÇÊûúÂéüÊñáÂåÖÂê´Êç¢Ë°åÁ¨¶ÔºåËØ∑Âú®ËØëÊñá‰∏≠‰πü‰øùÊåÅÊç¢Ë°å„ÄÇ\n7. Â¶ÇÊûúÂéüÊñáÂåÖÂê´ÊñπÊã¨Âè∑ \`[]\` (‰æãÂ¶Ç \`[Condition]\`)ÔºåËØ∑‰øùÊåÅÂéüÊñá‰∏çË¶ÅÁøªËØëÔºåÊàñËÄÖÂè™ÁøªËØëÊñπÊã¨Âè∑‰πãÂ§ñÁöÑÈÉ®ÂàÜÔºåÁªùÂØπ‰∏çË¶Å‰øÆÊîπÊñπÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ„ÄÇ\n8. ‰øùÁïôÊâÄÊúâ \`##...##\` Ê†ºÂºèÁöÑÂèòÈáèÂêç‰∏çË¶ÅÁøªËØë„ÄÇ\n\n„ÄêÂæÖÁøªËØëÂÜÖÂÆπ„ÄëÔºö\n`;
        let content = "", count = 0;
        const iterateList = scope === 'all' ? extractedData.map((d, i) => i) : filteredIndices;
        iterateList.forEach(idx => {
            const d = extractedData[idx];
            if(shouldInclude(d) && !d.trans) { content += `{{ID:${d.id}}} ${d.orig}\n`; count++; }
        });
        if(count === 0) content = "ÔºàÊ≤°ÊúâÊâæÂà∞Êú™ÁøªËØëÁöÑÊù°ÁõÆÔºâ";
        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiCount').innerText = `ÂáÜÂ§áÂØºÂá∫: ${count} Êù°`;
    }

    function copyAIPrompt() { document.getElementById('aiPromptText').select(); document.execCommand('copy'); showToast("Â∑≤Â§çÂà∂ÊèêÁ§∫ËØçÔºÅ"); }

    // --- Helper for wrapping logic ---
    function wrapText(text, limit) {
        let regex = new RegExp(`.{1,${limit}}`, 'g');
        let parts = text.match(regex);
        return parts ? parts.join('\n') : text;
    }

    // --- Patch Generation ---
    function generatePatchMod() {
        if(!extractedData.length) return showToast("Ê≤°ÊúâÊï∞ÊçÆÔºÅ");
        
        let patchContent = `#modname "${originalFileName.replace(/_/g, ' ')} CN Patch"\n#description "Translation patch for ${originalFileName}"\n#domversion 600\n\n`;
        let patches = new Map();

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        
        // Paragraph Preservation Flags
        const keepParaDescr = document.getElementById('opt_keep_para_descr').checked;
        const keepParaEvent = document.getElementById('opt_keep_para_event').checked;

        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitEvent = parseInt(document.getElementById('limit_event').value) || 35;
        const limitItem = parseInt(document.getElementById('limit_item').value) || 30; 
        const limitOther = parseInt(document.getElementById('limit_other').value) || 42;

        extractedData.forEach(d => {
            if (!d.trans || !shouldInclude(d) || !d.ctxId) return;

            let selectCmd = patchCmdMap[d.ctxCmd];
            if (!selectCmd) return;

            let key = `${selectCmd} ${d.ctxId}`;
            if (!patches.has(key)) patches.set(key, []);

            let finalTrans = d.trans;
            if (d.cmdType === 'descr') {
                let limit = limitOther; 
                if (d.type.cat === 'nation') limit = limitNation;
                else if (d.type.cat === 'spell') limit = limitSpell;
                else if (d.type.cat === 'event') limit = limitEvent;
                else if (d.type.cat === 'item') limit = limitItem; 

                let isEventText = ['#msg', '#text', '#killermsg'].includes(d.cmd);
                let keepPara = isEventText ? keepParaEvent : keepParaDescr;

                if (useAutoWrap) {
                    if (keepPara) {
                         let paragraphs = finalTrans.split(/\r?\n/);
                         finalTrans = paragraphs.map(p => wrapText(p, limit)).join('\n');
                    } else {
                         let clean = finalTrans.replace(/\r?\n/g, ' '); 
                         finalTrans = wrapText(clean, limit);
                    }
                }
            }

            patches.get(key).push(`${d.cmd} "${finalTrans}"`);
        });

        if (patches.size === 0) return showToast("Ê≤°ÊúâÊâæÂà∞ÂèØÁîüÊàêË°•‰∏ÅÁöÑÁøªËØëÂÜÖÂÆπ");

        patches.forEach((cmds, key) => {
            patchContent += `${key}\n`;
            cmds.forEach(c => patchContent += `${c}\n`);
            patchContent += `#end\n\n`;
        });

        const blob = new Blob(["\uFEFF" + patchContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_Patch.dm`;
        a.click();
        showToast(`Ë°•‰∏ÅÁîüÊàêÊàêÂäüÔºÅ`);
    }

    // --- Full Mod Generation ---
    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let globalTranslationMap = {}; 

        const useAutoWrap = document.getElementById('opt_auto_wrap').checked;
        const useGlobalSync = document.getElementById('opt_global_sync').checked;
        const forceReformat = document.getElementById('opt_force_reformat').checked;
        
        // Preservation Flags
        const keepParaDescr = document.getElementById('opt_keep_para_descr').checked;
        const keepParaEvent = document.getElementById('opt_keep_para_event').checked;

        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitEvent = parseInt(document.getElementById('limit_event').value) || 35;
        const limitItem = parseInt(document.getElementById('limit_item').value) || 30; 
        const limitOther = parseInt(document.getElementById('limit_other').value) || 42;

        extractedData.forEach(d => {
            let textToUse = d.trans ? d.trans : (forceReformat && shouldInclude(d) ? d.orig : null);

            if (textToUse !== null && shouldInclude(d)) {
                let finalTrans = textToUse;
                
                // Smart Wrap
                if (d.cmdType === 'descr') {
                    let limit = limitOther; 
                    if (d.type.cat === 'nation') limit = limitNation;
                    else if (d.type.cat === 'spell') limit = limitSpell;
                    else if (d.type.cat === 'event') limit = limitEvent;
                    else if (d.type.cat === 'item') limit = limitItem; 

                    let isEventText = ['#msg', '#text', '#killermsg'].includes(d.cmd);
                    let keepPara = isEventText ? keepParaEvent : keepParaDescr;

                    if (useAutoWrap || forceReformat) {
                        if (keepPara) {
                            let paragraphs = finalTrans.split(/\r?\n/);
                            finalTrans = paragraphs.map(p => wrapText(p, limit)).join('\n');
                        } else {
                            let clean = finalTrans.replace(/\r?\n/g, ' '); 
                            finalTrans = wrapText(clean, limit);
                        }
                    }
                }

                newLines[d.startLine] = `${d.cmd} "${finalTrans}"`;
                for(let k = d.startLine + 1; k <= d.endLine; k++) { newLines[k] = "__DELETED_LINE__"; }
                modifyCount++;

                if (useGlobalSync && d.cmdType === 'name' && d.trans) {
                    let allowSync = false;
                    if (d.type.cat === 'unit' && document.getElementById('sync_unit_name').checked) allowSync = true;
                    if (d.type.cat === 'spell' && document.getElementById('sync_spell_name').checked) allowSync = true;
                    if (d.type.cat === 'item' && document.getElementById('sync_item_name').checked) allowSync = true;
                    if (d.type.cat === 'site' && document.getElementById('sync_site_name').checked) allowSync = true;
                    if (d.type.cat === 'event' && document.getElementById('sync_event_name').checked) allowSync = true;
                    if (d.type.cat === 'misc' && document.getElementById('sync_misc_name').checked) allowSync = true;
                    if (d.type.cat === 'nation') {
                        if (d.cmd === '#name' && document.getElementById('sync_nation_name').checked) allowSync = true;
                        if (d.cmd === '#epithet' && document.getElementById('sync_nation_epithet').checked) allowSync = true;
                    }
                    if (allowSync) globalTranslationMap[d.orig.toLowerCase()] = d.trans;
                }
            }
        });

        newLines = newLines.filter(l => l !== "__DELETED_LINE__");

        if (useGlobalSync && Object.keys(globalTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1], content = match[2];
                    if (!noReplaceCmds.includes(cmd) && globalTranslationMap[content.toLowerCase()]) {
                        return line.replace(`"${content}"`, `"${globalTranslationMap[content.toLowerCase()]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`ÁîüÊàêÊàêÂäüÔºÅ`);
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const chunks = text.split(/\{\{ID[:Ôºö](\d+)\}\}/);
        let count = 0;
        for(let i=1; i<chunks.length; i+=2) {
            let id = parseInt(chunks[i]);
            let content = chunks[i+1].trim();
            content = content.replace(/```$/, "").trim();
            if(extractedData[id]) { extractedData[id].trans = content; count++; }
        }
        document.getElementById('importModal').classList.remove('active');
        showToast(`ÂØºÂÖ• ${count} Êù°Êï∞ÊçÆ`);
        filterData();
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(msg) { 
        const t = document.getElementById('toast'); 
        t.innerHTML = `<i class="fa-solid fa-circle-info"></i> <span>${msg}</span>`; 
        t.classList.add('show'); 
        setTimeout(() => t.classList.remove('show'), 3000); 
    }
</script>
</body>
</html>