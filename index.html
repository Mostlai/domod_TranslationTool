<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå°</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --gold: #d4af37;
            --gold-dim: #7a6030;
            --text: #e0e0e0;
            --border: 1px solid #444;
            /* Category Colors */
            --tag-unit: #8b2e2e; --tag-spell: #5d3f82; 
            --tag-item: #b8860b; --tag-site: #2f4f4f;
            --tag-event: #2e7d32; --tag-nation: #1e88e5; --tag-misc: #555;
        }

        body {
            background: var(--bg-color) url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: var(--text); font-family: "Segoe UI", sans-serif;
            margin: 0; padding: 20px; display: flex; flex-direction: column; height: 98vh;
        }

        /* Header */
        header { border-bottom: 2px solid var(--gold-dim); padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: var(--gold); margin: 0; font-family: "Palatino Linotype", serif; text-shadow: 2px 2px 0 #000; letter-spacing: 1px; }

        /* Control Panel */
        .control-panel {
            background: var(--panel-bg); border: var(--border); padding: 15px;
            display: grid; grid-template-columns: 240px 1fr 180px; gap: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6); margin-bottom: 15px;
        }

        .col-file { display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #333; padding-right: 15px; justify-content: center; }
        select { background: #000; color: #fff; border: 1px solid #555; padding: 5px; width: 100%; cursor: pointer; }

        /* Configuration Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            background: #151515; padding: 10px; border: 1px solid #333; border-radius: 4px;
        }
        .config-group { display: flex; flex-direction: column; gap: 3px; background: rgba(255,255,255,0.03); padding: 5px; border-radius: 3px; }
        .head { font-size: 11px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #444; margin-bottom: 3px; padding-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        
        .advanced-options {
            grid-column: span 4; border-top: 1px solid #444; margin-top: 5px; padding-top: 5px;
            display: flex; gap: 15px; align-items: center; background: #222; padding: 8px; border-radius: 4px;
        }

        label { font-size: 11px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #bbb; transition: 0.2s; white-space: nowrap; }
        label:hover { color: #fff; }
        input[type="checkbox"] { accent-color: var(--gold); }

        .col-actions { display: flex; flex-direction: column; gap: 10px; justify-content: center; padding-left: 10px; border-left: 1px solid #333; }

        .btn {
            background: #2d2d2d; color: var(--gold); border: 1px solid var(--gold-dim);
            padding: 8px 10px; cursor: pointer; font-weight: bold; font-size: 12px; text-align: center;
            transition: all 0.2s; white-space: nowrap;
        }
        .btn:hover { background: #444; border-color: #fff; transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(#5e1111, #3b0808); color: #fff; border-color: #a63434; font-size: 13px; padding: 10px; }
        .btn-success { background: linear-gradient(#1e3c1e, #0f1f0f); border-color: #2e8b57; color: #90ee90; }
        .btn-purple { background: linear-gradient(#4a148c, #311b92); border-color: #7c4dff; color: #e1bee7; } /* AI Button Color */

        /* Filter Bar */
        .filter-bar {
            display: flex; gap: 5px; margin-bottom: 0; background: #1a1a1a; 
            padding: 8px 10px 0 10px; border: 1px solid #444; border-bottom: none;
            align-items: center;
        }
        
        .tab-btn {
            background: #222; border: 1px solid #444; border-bottom: none;
            color: #888; padding: 8px 15px; cursor: pointer; font-size: 12px; font-weight: bold;
            border-radius: 4px 4px 0 0; transition: 0.2s; position: relative; top: 1px;
        }
        .tab-btn:hover { background: #333; color: #ddd; }
        .tab-btn.active { background: rgba(30,30,30,0.9); color: #fff; border-color: var(--gold-dim); border-bottom: 1px solid rgba(30,30,30,0.9); z-index: 2; }
        
        .tab-btn[data-cat="all"].active { border-top: 3px solid var(--gold); }
        .tab-btn[data-cat="unit"].active { border-top: 3px solid var(--tag-unit); }
        .tab-btn[data-cat="spell"].active { border-top: 3px solid var(--tag-spell); }
        .tab-btn[data-cat="item"].active { border-top: 3px solid var(--tag-item); }
        .tab-btn[data-cat="site"].active { border-top: 3px solid var(--tag-site); }
        .tab-btn[data-cat="nation"].active { border-top: 3px solid var(--tag-nation); }
        .tab-btn[data-cat="event"].active { border-top: 3px solid var(--tag-event); }
        .tab-btn[data-cat="misc"].active { border-top: 3px solid var(--tag-misc); }

        .search-box { margin-left: auto; position: relative; }
        .search-input {
            background: #000; border: 1px solid #555; color: #fff;
            padding: 6px 10px; border-radius: 15px; font-size: 12px; width: 200px;
            transition: 0.2s;
        }
        .search-input:focus { border-color: var(--gold); outline: none; width: 250px; }
        .counter { font-size: 11px; color: #666; margin-left: 10px; min-width: 100px; text-align: right;}

        /* Table */
        .table-wrap { flex: 1; overflow-y: auto; border: var(--border); background: rgba(30,30,30,0.9); position: relative; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #181818; color: var(--gold); padding: 10px; position: sticky; top: 0; text-align: left; z-index: 5; border-bottom: 1px solid var(--gold-dim); }
        td { padding: 6px 10px; border-bottom: 1px solid #333; vertical-align: top; line-height: 1.4; }
        tr:hover td { background: #252525; }

        textarea {
            width: 98%; min-height: 28px; background: #0b0b0b; color: #ddd;
            border: 1px solid #444; padding: 4px; resize: vertical; font-family: inherit;
        }
        textarea:focus { border-color: var(--gold); outline: none; background: #000; }

        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: bold; display: inline-block; min-width: 35px; text-align: center; margin-right: 5px; box-shadow: 1px 1px 2px black;}
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        .alert-dupe { color: #ff5555; font-size: 10px; border: 1px solid #ff5555; padding: 0 3px; border-radius: 2px; margin-right:5px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-box { background: #222; border: 2px solid var(--gold); padding: 20px; width: 700px; box-shadow: 0 0 40px #000; display: flex; flex-direction: column; gap: 10px;}

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; border: 1px solid var(--gold); padding: 12px 24px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; border-radius: 4px; box-shadow: 0 5px 15px #000; }
        #toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Dominions 6 Mod æ±‰åŒ–å·¥ä½œå°</h1>
        <div style="font-size:12px; color:#888;">æ¨èä¸å‹¾é€‰å›½å®¶Nameç¿»è¯‘</div>
    </div>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <label style="color:var(--gold); font-weight:bold;">1. æ–‡ä»¶æ“ä½œ</label>
        <select id="encodingSelect">
            <option value="UTF-8">è¯»å–ç¼–ç : UTF-8</option>
            <option value="windows-1252">è¯»å–ç¼–ç : Windows-1252</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ä¸Šä¼  .dm æ–‡ä»¶</button>
    </div>

    <!-- 2. Config -->
    <div class="config-grid">
        <!-- Spells -->
        <div class="config-group">
            <div class="head" style="color:#ab82ff">ğŸ”® æ³•æœ¯</div>
            <label><input type="checkbox" id="cfg_spell_name"> Name</label>
            <label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label>
        </div>
        <!-- Units -->
        <div class="config-group">
            <div class="head" style="color:#ff4444">âš”ï¸ å•ä½</div>
            <label><input type="checkbox" id="cfg_unit_name"> Name</label>
            <label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label>
        </div>
        <!-- Items -->
        <div class="config-group">
            <div class="head" style="color:#ffd700">ğŸ›¡ï¸ ç‰©å“</div>
            <label><input type="checkbox" id="cfg_item_name"> Name</label>
            <label><input type="checkbox" id="cfg_item_descr" checked> Descr</label>
        </div>
        <!-- Sites -->
        <div class="config-group">
            <div class="head" style="color:#00ced1">ğŸ›ï¸ é—è¿¹</div>
            <label><input type="checkbox" id="cfg_site_name"> Name</label>
            <label><input type="checkbox" id="cfg_site_descr" checked> Descr</label>
        </div>
        <!-- Nation -->
        <div class="config-group">
            <div class="head" style="color:#1e88e5">ğŸš© å›½å®¶</div>
            <label><input type="checkbox" id="cfg_nation_name"> Name</label>
            <label><input type="checkbox" id="cfg_nation_descr" checked> Info</label>
        </div>
        <!-- Events -->
        <div class="config-group">
            <div class="head" style="color:#4caf50">ğŸ“œ äº‹ä»¶</div>
            <label><input type="checkbox" id="cfg_event_name"> Name</label>
            <label><input type="checkbox" id="cfg_event_descr" checked> Msg</label>
        </div>
        <!-- Misc -->
        <div class="config-group">
            <div class="head" style="color:#ccc">ğŸŒ æ‚é¡¹</div>
            <label><input type="checkbox" id="cfg_misc_name"> Name</label>
            <label><input type="checkbox" id="cfg_misc_descr" checked> Text</label>
        </div>

        <div class="advanced-options">
            <span style="color:var(--gold); font-size:11px; font-weight:bold;">âš¡ é«˜çº§:</span>
            <label title="è‡ªåŠ¨æ›¿æ¢ #startsite å’Œ #futuresite ä¸­çš„å¼•ç”¨"><input type="checkbox" id="opt_link_sites" checked> è‡ªåŠ¨æ›´æ–°é—è¿¹å¼•ç”¨ (Reference)</label>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <!-- New AI Button -->
        <button class="btn btn-purple" onclick="generateAIPrompt()">2. AI æç¤ºè¯å¯¼å‡º</button>
        <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')">3. å¯¼å…¥ç¿»è¯‘ç»“æœ</button>
        <button class="btn btn-primary" onclick="generateModFile()">âš¡ ç”Ÿæˆ Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all">å…¨éƒ¨</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit">å•ä½</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell">æ³•æœ¯</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item">ç‰©å“</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site">é—è¿¹</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation">å›½å®¶</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event">äº‹ä»¶</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc">æ‚é¡¹</button>

    <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ ID / åŸæ–‡ / æŒ‡ä»¤..." oninput="renderTable()">
    </div>
    <div class="counter" id="rowCounter">0 / 0</div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="80">åˆ†ç±»/ID</th>
                <th width="100">æŒ‡ä»¤</th>
                <th width="40%">åŸæ–‡</th>
                <th>è¯‘æ–‡</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:50px; color:#666;">ç­‰å¾…ä¸Šä¼ ...</td></tr>
        </tbody>
    </table>
</div>

<!-- AI Prompt Modal -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e1bee7; margin-top:0;">AI æç¤ºè¯ç”Ÿæˆ (Prompt Mode)</h3>
        <p style="font-size:12px; color:#aaa; margin:0;">
            æç¤ºï¼šä¸ºé¿å… AI ä¸Šä¸‹æ–‡æº¢å‡ºï¼Œå»ºè®®é…åˆâ€œæ ‡ç­¾é¡µâ€åˆ†æ‰¹å¯¼å‡ºï¼ˆå¦‚å…ˆå¯¼å‡ºæ³•æœ¯ï¼Œå†å¯¼å‡ºç‰©å“ï¼‰ã€‚
            <br>è¯·å°†ä¸‹æ–¹å†…å®¹å®Œæ•´å¤åˆ¶ç»™ ChatGPT / Claude / Kimiï¼Œå¹¶å°† AI çš„å›å¤ç²˜è´´å›â€œå¯¼å…¥â€çª—å£ã€‚
        </p>
        <textarea id="aiPromptText" style="height:350px; font-family:monospace; color:#e1bee7; border-color:#7c4dff;" readonly></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">å…³é—­</button>
            <button class="btn btn-purple" onclick="copyAIPrompt()">å¤åˆ¶æç¤ºè¯</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold); margin-top:0;">å¯¼å…¥ç¿»è¯‘ç»“æœ</h3>
        <p style="font-size:12px; color:#aaa; margin:0;">æ”¯æŒç›´æ¥ç²˜è´´ AI çš„å›å¤å†…å®¹ï¼Œæˆ–è€…æµè§ˆå™¨ç¿»è¯‘åçš„ç½‘é¡µå†…å®¹ã€‚</p>
        <textarea id="pasteArea" style="height:350px; font-family:monospace;" placeholder="Ctrl+V ç²˜è´´..."></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">å…³é—­</button>
            <button class="btn btn-primary" onclick="processImport()">ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<div id="toast">Ready</div>

<script>
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n", currentFilter = 'all';

    const typeMap = {
        '#newmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'å•ä½', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'}, '#selectweapon': {cat:'item', l:'æ­¦å™¨', c:'bg-item'},
        '#newarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'}, '#selectarmor': {cat:'item', l:'é˜²å…·', c:'bg-item'},
        '#newitem': {cat:'item', l:'å®ç‰©', c:'bg-item'}, '#selectitem': {cat:'item', l:'å®ç‰©', c:'bg-item'},
        '#newspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'æ³•æœ¯', c:'bg-spell'},
        '#newsite': {cat:'site', l:'é—è¿¹', c:'bg-site'}, '#selectsite': {cat:'site', l:'é—è¿¹', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'å›½å®¶', c:'bg-nation'},
        '#newevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'}, '#selectevent': {cat:'event', l:'äº‹ä»¶', c:'bg-event'},
    };
    
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief'];
    const refCmds = ['#startsite', '#futuresite'];

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const encoding = document.getElementById('encodingSelect').value;
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, encoding);
    });

    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        originalLines.forEach(l => {
            const m = l.match(/^#name\s+"([^"]*)"/); 
            if(m) nameFrequency[m[1]] = (nameFrequency[m[1]]||0)+1;
        });

        let ctxCmd = "Global", ctxId = "";
        originalLines.forEach((line, index) => {
            const trimLine = line.trim();
            if(!trimLine.startsWith('#')) return;

            const parts = trimLine.split(' ');
            if(parts[0].startsWith('#new') || parts[0].startsWith('#select') || typeMap[parts[0]]) {
                ctxCmd = parts[0];
                ctxId = parts.length > 1 ? parts[1] : "";
            }

            const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
            if(match && targetCmds.includes(match[1])) {
                const cmd = match[1];
                const content = match[2];
                const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'æ‚é¡¹', c:'bg-misc'};

                let cmdType = 'other';
                if(['#name','#landname','#itemname','#modname'].includes(cmd)) cmdType = 'name';
                else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                extractedData.push({
                    lineIdx: index,
                    id: extractedData.length,
                    type: typeInfo,
                    cmdType: cmdType,
                    ctxId: ctxId,
                    cmd: cmd,
                    orig: content,
                    trans: "",
                    isDupe: (cmd === '#name' && nameFrequency[content] > 1)
                });
            }
        });
        setFilter('all');
        showToast(`åŠ è½½æˆåŠŸï¼š${extractedData.length} æ¡æ•°æ®`);
    }

    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        
        if(!extractedData.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">æ— æ•°æ®</td></tr>'; return; }
        
        let html = "";
        let visibleCount = 0;

        extractedData.forEach(d => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return;
            }

            visibleCount++;
            if (visibleCount > 1000) return;

            const warn = d.isDupe ? `<span class="alert-dupe">é‡å</span>` : '';
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><span style="font-size:10px; color:#666">${d.ctxId}</span></td>
                <td style="color:#8abeb7; font-family:monospace;">${d.cmd}</td>
                <td style="color:#aaa;">${warn}${escapeHtml(d.orig)}</td>
                <td><textarea id="t_${d.id}" oninput="updateTrans(${d.id}, this.value)">${d.trans}</textarea></td>
            </tr>`;
        });

        if (visibleCount > 1000) html += `<tr><td colspan="4" style="text-align:center; color:#ff5555;">ç»“æœè¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 1000 æ¡ã€‚</td></tr>`;
        else if (visibleCount === 0) html = `<tr><td colspan="4" style="text-align:center; color:#666;">æ²¡æœ‰åŒ¹é…çš„ç»“æœ</td></tr>`;

        tbody.innerHTML = html;
        document.getElementById('rowCounter').innerText = `æ˜¾ç¤º: ${visibleCount} / æ€»è®¡: ${extractedData.length}`;
    }

    function updateTrans(id, val) { extractedData[id].trans = cleanText(val); }

    function cleanText(t) {
        if(!t) return "";
        return t.replace(/[\r\n]+/g, "\\n").replace(/\\ n/g, "\\n").replace(/\/ n/g, "\\n")
                .replace(/â€œ/g, "'").replace(/â€/g, "'").replace(/"/g, "'").trim();
    }

    function shouldInclude(item) {
        const cat = item.type.cat;
        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;
        if (cfgName === undefined || cfgDescr === undefined) return false;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    // --- AI Prompt Logic ---
    function generateAIPrompt() {
        if(!extractedData.length) return showToast("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
        
        // System Prompt
        const promptHeader = 
`ä½ æ˜¯ä¸€ä½ç²¾é€šç­–ç•¥æ¸¸æˆã€ŠDominions 6ã€‹(ç¥åŸŸ6) çš„ä¸“ä¸šæœ¬åœ°åŒ–ç¿»è¯‘ä¸“å®¶ã€‚è¯·å¸®æˆ‘å°†ä»¥ä¸‹ Mod æ–‡æœ¬ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ã€‚

ã€æ ¸å¿ƒè§„åˆ™ã€‘
1. æ ¼å¼å¿…é¡»ä¸¥æ ¼ä¿æŒä¸å˜ï¼šæ¯è¡Œå¼€å¤´æ˜¯ {{ID:æ•°å­—}}ï¼Œåé¢ç´§è·ŸåŸæ–‡ã€‚è¯·è¾“å‡º {{ID:æ•°å­—}} åŠ ä¸Š ç¿»è¯‘åçš„æ–‡æœ¬ã€‚
2. ç»å¯¹ä¸è¦ç¿»è¯‘ã€ä¿®æ”¹æˆ–åˆ é™¤ {{ID:xxx}} æ ‡ç­¾ã€‚
3. è¯·ä»¥ä»£ç å—æ ¼å¼è¾“å‡ºç»“æœï¼Œä»¥ä¾¿æˆ‘å¤åˆ¶ã€‚
4. é‡åˆ°æ¸¸æˆæœ¯è¯­è¯·ä¿æŒä¸“ä¸šæ€§ï¼ˆå¦‚ MR=é­”æ³•æŠ—æ€§, Protection=é˜²å¾¡å€¼ï¼‰ã€‚
5. é£æ ¼è¦æ±‚ï¼šå²è¯—æ„Ÿã€å¥‡å¹»é£æ ¼ã€ä¿¡è¾¾é›…ã€‚
6. å¦‚æœä¸€è¡ŒåŸæ–‡ä¸ºç©ºï¼Œè¯·ç›´æ¥è¾“å‡ºå¯¹åº”çš„ ID æ ‡ç­¾å³å¯ã€‚

ã€å¾…ç¿»è¯‘å†…å®¹ã€‘ï¼š
`;

        let content = "";
        let count = 0;
        
        extractedData.forEach(d => {
            // åªå¯¼å‡ºç¬¦åˆå½“å‰å¤é€‰æ¡†é…ç½® ä¸” ç¬¦åˆå½“å‰æ ‡ç­¾é¡µç­›é€‰ çš„å†…å®¹
            // è¿™æ ·ç”¨æˆ·å¯ä»¥é€šè¿‡åˆ‡æ¢æ ‡ç­¾é¡µæ¥åˆ†æ‰¹å¤„ç†
            if(shouldInclude(d) && (currentFilter === 'all' || d.type.cat === currentFilter) && !d.trans) {
                content += `{{ID:${d.id}}} ${d.orig}\n`;
                count++;
            }
        });

        if(count === 0) return showToast("å½“å‰ç­›é€‰èŒƒå›´å†…æ²¡æœ‰éœ€è¦ç¿»è¯‘çš„å†…å®¹ï¼ˆæˆ–å·²è¢«ç¿»è¯‘ï¼‰");
        if(count > 1000) showToast(`æ³¨æ„ï¼šå½“å‰å¯¼å‡ºäº† ${count} æ¡æ–‡æœ¬ï¼Œå¯èƒ½è¶…è¿‡ AI å•æ¬¡å›å¤é•¿åº¦ï¼Œå»ºè®®ä½¿ç”¨æ ‡ç­¾é¡µåˆ†æ‰¹å¯¼å‡ºã€‚`);

        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiPromptModal').classList.add('active');
    }

    function copyAIPrompt() {
        const el = document.getElementById('aiPromptText');
        el.select();
        document.execCommand('copy');
        showToast("å·²å¤åˆ¶æç¤ºè¯ï¼è¯·å» AI å¤„ç²˜è´´ã€‚");
    }

    // --- Export / Import / Generate ---
    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let siteTranslationMap = {}; 

        extractedData.forEach(d => {
            if(d.trans && shouldInclude(d)) {
                const line = newLines[d.lineIdx];
                newLines[d.lineIdx] = line.replace(`"${d.orig}"`, `"${d.trans}"`);
                modifyCount++;
                if (document.getElementById('opt_link_sites').checked && d.type.cat === 'site' && d.cmd === '#name') {
                    siteTranslationMap[d.orig] = d.trans;
                }
            }
        });

        if (document.getElementById('opt_link_sites').checked && Object.keys(siteTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1];
                    const content = match[2];
                    if (refCmds.includes(cmd) && siteTranslationMap[content]) {
                        return line.replace(`"${content}"`, `"${siteTranslationMap[content]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`ç”ŸæˆæˆåŠŸï¼å·²ä¿®æ”¹ ${modifyCount} è¡Œ`);
    }

    function exportBridgeHTML() {
        if(!extractedData.length) return;
        let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Trans</title><style>p{margin:5px 0; padding:8px; border-left:3px solid gold; background:#f4f4f4; font-family:sans-serif;}</style></head><body><h3>è¯·ç¿»è¯‘æ­¤é¡µé¢ï¼Œç„¶åå…¨é€‰å¤åˆ¶ã€‚</h3>`;
        extractedData.forEach(d => {
            if(shouldInclude(d) && (currentFilter === 'all' || d.type.cat === currentFilter)) {
                html += `<p>{{ID:${d.id}}}${escapeHtml(d.orig)}</p>\n`;
            }
        });
        html += "</body></html>";
        const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([html],{type:'text/html'})); 
        a.download="translate_bridge.html"; a.click();
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const regex = /\{\{ID[:ï¼š](\d+)\}\}\s*(.*)/gi;
        let count = 0;
        text.split('\n').forEach(l => {
            regex.lastIndex=0; const m=regex.exec(l);
            if(m) {
                const id = parseInt(m[1]);
                const tr = cleanText(m[2]);
                if(extractedData[id] && tr && tr!==cleanText(extractedData[id].orig)) {
                    extractedData[id].trans = tr;
                    const el=document.getElementById('t_'+id); if(el) el.value=tr;
                    count++;
                }
            }
        });
        document.getElementById('importModal').classList.remove('active');
        showToast(`å¯¼å…¥å¹¶ä¿®å¤ ${count} æ¡æ•°æ®`);
        renderTable(); 
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>