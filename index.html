<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominions 6 Mod 汉化工作台</title>
    <!-- 引入 Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --panel-bg: rgba(25, 25, 25, 0.95);
            --border-color: #3a3a3a;
            --gold-primary: #c5a059;
            --gold-hover: #e6c278;
            --gold-dim: #7a6030;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            
            /* Category Colors */
            --tag-unit: #8b2e2e; --tag-spell: #6a4c93; 
            --tag-item: #b8860b; --tag-site: #2f4f4f;
            --tag-event: #2e7d32; --tag-nation: #1565c0; --tag-misc: #555;
        }

        /* --- Global Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; border: 1px solid #222; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0.75)),
                url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: var(--text-main);
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column;
            height: 98vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            border-bottom: 1px solid var(--gold-dim);
            padding-bottom: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: radial-gradient(circle at center, rgba(197, 160, 89, 0.05) 0%, transparent 80%);
        }
        
        .header-title h1 {
            color: var(--gold-primary); margin: 0;
            font-family: "Palatino Linotype", serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 1px; font-weight: normal; font-size: 24px;
        }
        .header-title span { font-size: 12px; color: #888; margin-top: 5px; display: block; }
        .version-tag { font-size: 11px; color: var(--gold-dim); border: 1px solid var(--gold-dim); padding: 1px 5px; border-radius: 4px; vertical-align: middle; margin-left: 8px; }

        /* GitHub Button */
        .github-link {
            text-decoration: none; color: #ccc;
            background: #222; border: 1px solid #444;
            padding: 8px 15px; border-radius: 20px;
            font-size: 14px; transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .github-link:hover {
            color: #fff; border-color: var(--gold-primary);
            background: #333; box-shadow: 0 0 10px rgba(197, 160, 89, 0.2);
        }

        /* --- Control Panel --- */
        .control-panel {
            background: var(--panel-bg);
            border: 1px solid var(--gold-dim);
            border-radius: 6px;
            padding: 20px;
            display: grid; grid-template-columns: 240px 1fr 180px; gap: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .col-title { color: var(--gold-primary); font-size: 13px; font-weight: bold; margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* File Inputs */
        .col-file { display: flex; flex-direction: column; gap: 12px; justify-content: start; }
        select { 
            background: #111; color: #ddd; border: 1px solid #444; 
            padding: 8px; border-radius: 4px; width: 100%; outline: none; cursor: pointer; transition: 0.2s;
        }
        select:hover { border-color: var(--gold-dim); }

        /* Config Grid */
        .config-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; border: 1px solid #333;
        }
        .config-group { display: flex; flex-direction: column; gap: 6px; }
        
        .head { 
            font-size: 12px; font-weight: bold; color: #ccc; 
            border-bottom: 1px solid #444; padding-bottom: 4px; margin-bottom: 4px; 
            display: flex; align-items: center; gap: 8px;
        }
        .head i { width: 16px; text-align: center; } 
        
        /* Advanced Options */
        .advanced-options {
            grid-column: span 4; border-top: 1px solid #444; margin-top: 5px; padding-top: 10px;
            display: flex; gap: 15px; align-items: flex-start;
        }
        
        .adv-block {
            flex: 1; display: flex; flex-direction: column; gap: 8px;
            background: rgba(255,255,255,0.02); padding: 8px; border-radius: 4px; border: 1px solid #333;
        }
        .adv-title { font-size: 11px; color: var(--gold-primary); font-weight: bold; margin-bottom: 2px; }

        label { font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #aaa; transition: 0.2s; white-space: nowrap;}
        label:hover { color: #fff; }
        input[type="checkbox"], input[type="radio"] { accent-color: var(--gold-primary); cursor: pointer; }
        
        input[type="number"] { 
            background: #000; color: var(--gold-primary); border: 1px solid #555; 
            width: 45px; padding: 2px 0; text-align: center; font-weight: bold; border-radius: 3px;
        }
        input[type="number"]:focus { border-color: var(--gold-primary); outline: none; }

        /* Actions */
        .col-actions { display: flex; flex-direction: column; gap: 12px; justify-content: center; }

        /* Buttons */
        .btn {
            background: linear-gradient(145deg, #2b2b2b, #1f1f1f);
            color: var(--text-main); border: 1px solid #444;
            padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 13px;
            border-radius: 4px; transition: all 0.2s; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); border-color: var(--gold-dim); color: #fff; }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { 
            background: linear-gradient(135deg, #5e1111 0%, #3b0808 100%); 
            color: #ffddd0; border-color: #8a2be2; border-color: #a63434;
        }
        .btn-success { background: linear-gradient(135deg, #1b3a1b 0%, #0d1f0d 100%); border-color: #2e7d32; color: #a5d6a7; }
        .btn-purple { background: linear-gradient(135deg, #4527a0 0%, #311b92 100%); border-color: #7c4dff; color: #d1c4e9; }
        .btn-fix { background: linear-gradient(135deg, #e65100 0%, #bf360c 100%); border-color: #ff8a65; color: #fff; }

        /* --- Filter Bar --- */
        .filter-bar {
            display: flex; gap: 4px; margin-bottom: 0; 
            padding: 0 10px; border-bottom: none;
            align-items: flex-end;
        }
        
        .tab-btn {
            background: #1a1a1a; border: 1px solid #333; border-bottom: none;
            color: #888; padding: 8px 18px; cursor: pointer; font-size: 12px; font-weight: bold;
            border-radius: 6px 6px 0 0; transition: 0.2s; position: relative; top: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .tab-btn:hover { background: #252525; color: #ddd; }
        .tab-btn.active { 
            background: var(--panel-bg); color: var(--gold-primary); 
            border-color: var(--gold-dim); border-bottom: 1px solid var(--panel-bg); 
            z-index: 5; padding-bottom: 10px; margin-top: -2px;
        }
        
        .tab-btn[data-cat="all"].active { border-top: 3px solid var(--gold-primary); }
        .tab-btn[data-cat="unit"].active { border-top: 3px solid var(--tag-unit); }
        .tab-btn[data-cat="spell"].active { border-top: 3px solid var(--tag-spell); }
        .tab-btn[data-cat="item"].active { border-top: 3px solid var(--tag-item); }
        .tab-btn[data-cat="site"].active { border-top: 3px solid var(--tag-site); }
        .tab-btn[data-cat="nation"].active { border-top: 3px solid var(--tag-nation); }
        .tab-btn[data-cat="event"].active { border-top: 3px solid var(--tag-event); }
        .tab-btn[data-cat="misc"].active { border-top: 3px solid var(--tag-misc); }

        .search-container {
            margin-left: auto; display: flex; align-items: center; gap: 10px; background: #1a1a1a;
            padding: 5px 10px; border-radius: 20px 20px 0 0; border: 1px solid #333; border-bottom: none;
        }
        .search-input {
            background: transparent; border: none; color: #fff;
            width: 180px; font-size: 13px; outline: none; transition: 0.3s;
        }
        .search-input:focus { width: 240px; }
        .search-input::placeholder { color: #555; }
        .counter { font-size: 11px; color: #666; white-space: nowrap;}

        /* --- Table --- */
        .table-wrap { 
            flex: 1; overflow-y: auto; 
            border: 1px solid var(--gold-dim); 
            background: var(--panel-bg); 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        
        th { 
            background: #111; color: var(--gold-primary); padding: 12px; 
            position: sticky; top: 0; text-align: left; z-index: 10; 
            border-bottom: 2px solid #333; font-family: "Palatino Linotype", serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        td { padding: 10px 12px; border-bottom: 1px solid #2a2a2a; vertical-align: top; line-height: 1.5; word-wrap: break-word;}
        tr:nth-child(even) { background: rgba(255,255,255,0.015); }
        tr:hover { background: rgba(197, 160, 89, 0.05); }

        textarea {
            width: 98%; 
            background: #0a0a0a; color: #e0e0e0;
            border: 1px solid #333; border-radius: 4px;
            padding: 8px; resize: vertical; font-family: inherit; line-height: 1.5;
            transition: all 0.2s;
            overflow: hidden; 
            min-height: 38px;
        }
        textarea:focus { 
            border-color: var(--gold-primary); background: #000; 
            box-shadow: 0 0 8px rgba(197, 160, 89, 0.15); outline: none; 
        }

        .badge { 
            padding: 2px 6px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: bold; 
            display: inline-block; min-width: 40px; text-align: center; margin-bottom: 4px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
        }
        .bg-unit { background: var(--tag-unit); } .bg-spell { background: var(--tag-spell); }
        .bg-item { background: var(--tag-item); } .bg-site { background: var(--tag-site); }
        .bg-event { background: var(--tag-event); } .bg-nation { background: var(--tag-nation); }
        .bg-misc { background: var(--tag-misc); }
        
        .alert-dupe { 
            color: #ff6b6b; font-size: 11px; border: 1px solid #ff6b6b; 
            background: rgba(100,0,0,0.2); padding: 2px 6px; border-radius: 3px; 
            display: inline-block; margin-bottom: 5px;
        }

        /* --- Pagination --- */
        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #111; padding: 10px 20px; border: 1px solid var(--gold-dim); border-top: none;
            border-radius: 0 0 6px 6px;
        }
        .page-btn {
            background: #222; color: #bbb; border: 1px solid #444;
            padding: 5px 12px; cursor: pointer; font-size: 12px; border-radius: 3px;
            transition: 0.2s;
        }
        .page-btn:hover { background: #333; color: #fff; border-color: var(--gold-primary); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #333; }

        /* --- Modals --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-box { 
            background: #1a1a1a; border: 1px solid var(--gold-primary); 
            padding: 25px; width: 750px; box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            display: flex; flex-direction: column; gap: 15px; border-radius: 8px;
        }
        
        .scope-options { 
            display: flex; gap: 20px; background: rgba(0,0,0,0.3); padding: 12px; 
            border: 1px solid #333; border-radius: 4px; 
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: #222; border: 1px solid var(--gold-primary); color: var(--gold-primary);
            padding: 12px 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; 
            border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); font-weight: bold;
        }
        #toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>Dominions 6 Mod 汉化工作台 <span class="version-tag">v2.7</span></h1>
    </div>
    <a href="https://github.com/Mostlai/domod_TranslationTool/tree/main" target="_blank" class="github-link">
        <i class="fa-brands fa-github fa-lg"></i> GitHub
    </a>
</header>

<div class="control-panel">
    <!-- 1. File -->
    <div class="col-file">
        <span class="col-title"><i class="fa-solid fa-file-code"></i> 1. 文件操作</span>
        <select id="encodingSelect">
            <option value="UTF-8">读取编码: UTF-8</option>
            <option value="windows-1252">读取编码: Windows-1252</option>
        </select>
        <input type="file" id="fileInput" accept=".dm" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-folder-open"></i> 上传 .dm 文件</button>
    </div>

    <!-- 2. Config -->
    <div class="col-config" style="grid-column: span 1;">
        <span class="col-title"><i class="fa-solid fa-sliders"></i> 2. 翻译范围</span>
        <div class="config-grid">
            <!-- Spells -->
            <div class="config-group">
                <div class="head" style="color:#ab82ff"><i class="fa-solid fa-hat-wizard"></i> 法术</div>
                <label><input type="checkbox" id="cfg_spell_name"> Name</label>
                <label><input type="checkbox" id="cfg_spell_descr" checked> Descr</label>
            </div>
            <!-- Units -->
            <div class="config-group">
                <div class="head" style="color:#ff4444"><i class="fa-solid fa-chess-knight"></i> 单位</div>
                <label><input type="checkbox" id="cfg_unit_name"> Name</label>
                <label><input type="checkbox" id="cfg_unit_descr" checked> Descr</label>
            </div>
            <!-- Items -->
            <div class="config-group">
                <div class="head" style="color:#ffd700"><i class="fa-solid fa-shield-halved"></i> 物品</div>
                <label><input type="checkbox" id="cfg_item_name"> Name</label>
                <label><input type="checkbox" id="cfg_item_descr" checked> Descr</label>
            </div>
            <!-- Sites -->
            <div class="config-group">
                <div class="head" style="color:#00ced1"><i class="fa-solid fa-dungeon"></i> 遗迹</div>
                <label><input type="checkbox" id="cfg_site_name"> Name</label>
                <label><input type="checkbox" id="cfg_site_descr" checked> Descr</label>
            </div>
            <!-- Nation -->
            <div class="config-group">
                <div class="head" style="color:#1e88e5"><i class="fa-solid fa-flag"></i> 国家</div>
                <label><input type="checkbox" id="cfg_nation_name"> Name</label>
                <label title="注意：称号(Epithet)不参与全局替换"><input type="checkbox" id="cfg_nation_epithet" checked> Epithet</label>
                <label><input type="checkbox" id="cfg_nation_descr" checked> Info</label>
            </div>
            <!-- Events -->
            <div class="config-group">
                <div class="head" style="color:#4caf50"><i class="fa-solid fa-scroll"></i> 事件</div>
                <label><input type="checkbox" id="cfg_event_name"> Name</label>
                <label><input type="checkbox" id="cfg_event_descr" checked> Msg</label>
            </div>
            <!-- Misc -->
            <div class="config-group">
                <div class="head" style="color:#ccc"><i class="fa-solid fa-layer-group"></i> 杂项</div>
                <label><input type="checkbox" id="cfg_misc_name"> Name</label>
                <label><input type="checkbox" id="cfg_misc_descr" checked> Text</label>
            </div>

            <div class="advanced-options">
                <div class="adv-block">
                    <span class="adv-title"><i class="fa-solid fa-link"></i> 全局替换</span>
                    <label title="推荐！覆盖所有指令中的同名引用（Epithet 除外）"><input type="checkbox" id="opt_global_sync" checked style="accent-color:#00e676"> 启用全局名称同步</label>
                </div>
                <div class="adv-block">
                    <span class="adv-title"><i class="fa-solid fa-align-left"></i> 强制换行设置 (字数)</span>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <label>国家: <input type="number" id="limit_nation" value="60"></label>
                        <label>法术: <input type="number" id="limit_spell" value="36"></label>
                        <label>单位/其他: <input type="number" id="limit_unit" value="46"></label>
                    </div>
                    <label title="如果勾选，即使不翻译（使用原文），生成Mod时也会强制去除原换行并按新规则重排"><input type="checkbox" id="opt_force_reformat" style="accent-color:#ff4444"> 即使未翻译也强制重排</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Actions -->
    <div class="col-actions">
        <span class="col-title" style="text-align:center"><i class="fa-solid fa-play"></i> 3. 执行操作</span>
        <button class="btn btn-purple" onclick="openAIPromptModal()"><i class="fa-solid fa-brain"></i> AI 提示词</button>
        <button class="btn btn-success" onclick="document.getElementById('importModal').classList.add('active')"><i class="fa-solid fa-file-import"></i> 导入翻译</button>
        <button class="btn btn-fix" onclick="autoFixSwappedNames()"><i class="fa-solid fa-wand-magic-sparkles"></i> 智能修复</button>
        <button class="btn btn-primary" onclick="generateModFile()"><i class="fa-solid fa-bolt"></i> 生成 Mod</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="tab-btn active" onclick="setFilter('all')" data-cat="all"><i class="fa-solid fa-border-all"></i> 全部</button>
    <button class="tab-btn" onclick="setFilter('unit')" data-cat="unit"><i class="fa-solid fa-chess-knight"></i> 单位</button>
    <button class="tab-btn" onclick="setFilter('spell')" data-cat="spell"><i class="fa-solid fa-hat-wizard"></i> 法术</button>
    <button class="tab-btn" onclick="setFilter('item')" data-cat="item"><i class="fa-solid fa-shield-halved"></i> 物品</button>
    <button class="tab-btn" onclick="setFilter('site')" data-cat="site"><i class="fa-solid fa-dungeon"></i> 遗迹</button>
    <button class="tab-btn" onclick="setFilter('nation')" data-cat="nation"><i class="fa-solid fa-flag"></i> 国家</button>
    <button class="tab-btn" onclick="setFilter('event')" data-cat="event"><i class="fa-solid fa-scroll"></i> 事件</button>
    <button class="tab-btn" onclick="setFilter('misc')" data-cat="misc"><i class="fa-solid fa-layer-group"></i> 杂项</button>

    <div class="search-container">
        <i class="fa-solid fa-magnifying-glass" style="color:#555"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="搜索 ID / 原文 / 指令..." oninput="filterData()">
        <div class="counter" id="rowCounter">0 / 0</div>
    </div>
</div>

<div class="table-wrap">
    <table id="dataTable">
        <thead>
            <tr>
                <th width="80">ID / 上下文</th>
                <th width="100">指令</th>
                <th width="40%">原文</th>
                <th>译文</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center; padding:50px; color:#666;">请上传 .dm 文件开始工作...</td></tr>
        </tbody>
    </table>
</div>

<div class="pagination-bar">
    <div class="page-info" id="pageInfo">第 1 / 1 页 (0 条)</div>
    <div class="page-ctrls">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)"><i class="fa-solid fa-chevron-left"></i> 上一页</button>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">下一页 <i class="fa-solid fa-chevron-right"></i></button>
    </div>
</div>

<!-- AI Modal -->
<div id="aiPromptModal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e1bee7; margin-top:0; display:flex; justify-content:space-between;">
            <span><i class="fa-solid fa-robot"></i> AI 提示词生成</span>
            <span id="aiCount" style="font-size:12px; color:#aaa; font-weight:normal; margin-top:5px;"></span>
        </h3>
        
        <div class="scope-options">
            <span style="color:#aaa; font-size:12px; font-weight:bold; align-self:center;">导出范围：</span>
            <label title="忽略上方标签页，扫描整个文件导出所有符合复选框的内容"><input type="radio" name="aiScope" value="all" checked onchange="regenerateAIPrompt()"> 导出所有未翻译项 (推荐)</label>
            <label title="只导出当前标签页和搜索结果"><input type="radio" name="aiScope" value="filtered" onchange="regenerateAIPrompt()"> 仅导出当前筛选结果</label>
        </div>

        <p style="font-size:12px; color:#aaa; margin:0 0 5px 0;">
            提示：如果总条目过多 (>1500条)，建议使用“筛选”模式分批导出，防止 AI 上下文溢出。
        </p>
        <textarea id="aiPromptText" style="height:300px; font-family:monospace; color:#e1bee7; border-color:#7c4dff;" readonly></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('aiPromptModal').classList.remove('active')">关闭</button>
            <button class="btn btn-purple" onclick="copyAIPrompt()"><i class="fa-regular fa-copy"></i> 复制</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold-primary); margin-top:0;"><i class="fa-solid fa-paste"></i> 导入翻译结果</h3>
        <textarea id="pasteArea" style="height:350px; font-family:monospace;" placeholder="请在此处粘贴 AI 返回的内容 (Ctrl+V)..."></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" onclick="document.getElementById('importModal').classList.remove('active')">关闭</button>
            <button class="btn btn-primary" onclick="processImport()"><i class="fa-solid fa-check"></i> 确认导入</button>
        </div>
    </div>
</div>

<div id="toast">Ready</div>

<script>
    let originalLines = [], extractedData = [], nameFrequency = {}, originalFileName = "mod", detectedLineEnding = "\n";
    let currentFilter = 'all', currentPage = 1;
    const itemsPerPage = 100;
    let filteredIndices = [];

    const typeMap = {
        '#newmonster': {cat:'unit', l:'单位', c:'bg-unit'}, '#selectmonster': {cat:'unit', l:'单位', c:'bg-unit'},
        '#newweapon': {cat:'item', l:'武器', c:'bg-item'}, '#selectweapon': {cat:'item', l:'武器', c:'bg-item'},
        '#newarmor': {cat:'item', l:'防具', c:'bg-item'}, '#selectarmor': {cat:'item', l:'防具', c:'bg-item'},
        '#newitem': {cat:'item', l:'宝物', c:'bg-item'}, '#selectitem': {cat:'item', l:'宝物', c:'bg-item'},
        '#newspell': {cat:'spell', l:'法术', c:'bg-spell'}, '#selectspell': {cat:'spell', l:'法术', c:'bg-spell'},
        '#newsite': {cat:'site', l:'遗迹', c:'bg-site'}, '#selectsite': {cat:'site', l:'遗迹', c:'bg-site'},
        '#selectnation': {cat:'nation', l:'国家', c:'bg-nation'},
        '#newevent': {cat:'event', l:'事件', c:'bg-event'}, '#selectevent': {cat:'event', l:'事件', c:'bg-event'},
    };
    
    const targetCmds = ['#name', '#landname', '#itemname', '#modname', '#descr', '#description', '#msg', '#text', '#killermsg', '#summary', '#brief', '#epithet'];
    const noReplaceCmds = targetCmds; 

    document.getElementById('fileInput').addEventListener('change', e => {
        const f = e.target.files[0];
        if(!f) return;
        originalFileName = f.name.replace(/\.dm$/i, "");
        const encoding = document.getElementById('encodingSelect').value;
        const r = new FileReader();
        r.onload = e => parseDM(e.target.result);
        r.readAsText(f, encoding);
    });

    // --- Parser ---
    function parseDM(text) {
        detectedLineEnding = text.indexOf('\r\n') > -1 ? '\r\n' : '\n';
        originalLines = text.split(/\r?\n/);
        extractedData = [];
        nameFrequency = {};

        originalLines.forEach(l => {
            const m = l.match(/^#name\s+"([^"]*)"/); 
            if(m) nameFrequency[m[1]] = (nameFrequency[m[1]]||0)+1;
        });

        let ctxCmd = "Global", ctxId = "";
        
        for (let i = 0; i < originalLines.length; i++) {
            let line = originalLines[i].trim();
            if (!line.startsWith('#')) continue;

            const parts = line.split(' ');
            if (parts[0].startsWith('#new') || parts[0].startsWith('#select') || typeMap[parts[0]]) {
                ctxCmd = parts[0];
                ctxId = parts.length > 1 ? parts[1] : "";
            }

            const cmdMatch = line.match(/^(#\w+)\s+"(.*)/); 
            if (cmdMatch) {
                let cmd = cmdMatch[1];
                let potentialContent = cmdMatch[2];
                let endQuoteIdx = potentialContent.lastIndexOf('"');
                let fullContent = "";
                let startLine = i;
                let endLine = i;

                if (endQuoteIdx !== -1 && endQuoteIdx === potentialContent.length - 1) {
                    fullContent = potentialContent.substring(0, endQuoteIdx);
                } else {
                    if (potentialContent.indexOf('"') !== -1) {
                         fullContent = potentialContent.substring(0, potentialContent.indexOf('"'));
                    } else {
                        let buffer = potentialContent;
                        let j = i + 1;
                        while (j < originalLines.length) {
                            let nextLine = originalLines[j];
                            let closeQuote = nextLine.indexOf('"');
                            if (closeQuote !== -1) {
                                buffer += "\n" + nextLine.substring(0, closeQuote);
                                endLine = j;
                                i = j;
                                break;
                            } else {
                                buffer += "\n" + nextLine;
                            }
                            j++;
                        }
                        fullContent = buffer;
                    }
                }

                if (targetCmds.includes(cmd)) {
                    const typeInfo = typeMap[ctxCmd] || {cat:'misc', l:'杂项', c:'bg-misc'};
                    let cmdType = 'other';
                    if(['#name','#landname','#itemname','#modname','#epithet'].includes(cmd)) cmdType = 'name';
                    else if(['#descr','#description','#msg','#text','#killermsg','#summary','#brief'].includes(cmd)) cmdType = 'descr';

                    extractedData.push({
                        startLine: startLine,
                        endLine: endLine,
                        id: extractedData.length,
                        type: typeInfo,
                        cmdType: cmdType,
                        ctxId: ctxId,
                        cmd: cmd,
                        orig: fullContent,
                        trans: "",
                        isDupe: (cmd === '#name' && nameFrequency[fullContent] > 1)
                    });
                }
            }
        }
        setFilter('all');
        showToast(`加载成功：${extractedData.length} 条数据`);
    }

    // --- Smart Fix ---
    function autoFixSwappedNames() {
        if(!extractedData.length) return showToast("没有数据");
        let groups = {};
        extractedData.forEach(d => {
            if(!d.ctxId) return; 
            let key = d.type.cat + "_" + d.ctxId;
            if(!groups[key]) groups[key] = [];
            groups[key].push(d);
        });

        let fixCount = 0;
        for (let key in groups) {
            let items = groups[key];
            let nameItem = items.find(i => i.cmdType === 'name' && i.trans.length > 0);
            let descrItem = items.find(i => i.cmdType === 'descr' && i.trans.length > 0);

            if (nameItem && descrItem) {
                if (nameItem.trans.length > 30 && descrItem.trans.length < 20) {
                    let temp = nameItem.trans;
                    nameItem.trans = descrItem.trans;
                    descrItem.trans = temp;
                    fixCount++;
                }
            }
        }

        if(fixCount > 0) {
            showToast(`已智能修复 ${fixCount} 处错位！`);
            renderTable(); 
        } else {
            showToast("未检测到明显的错位");
        }
    }

    // --- Filtering & Pagination ---
    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.cat === cat) btn.classList.add('active');
        });
        filterData();
    }

    function filterData() {
        const searchStr = document.getElementById('searchInput').value.toLowerCase();
        filteredIndices = extractedData.map((d, idx) => {
            if (currentFilter !== 'all' && d.type.cat !== currentFilter) return -1;
            if (searchStr) {
                const matchId = (d.ctxId || "").toLowerCase().includes(searchStr);
                const matchOrig = d.orig.toLowerCase().includes(searchStr);
                const matchCmd = d.cmd.toLowerCase().includes(searchStr);
                if (!matchId && !matchOrig && !matchCmd) return -1;
            }
            return idx;
        }).filter(idx => idx !== -1);
        currentPage = 1;
        renderTable();
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredIndices.length / itemsPerPage) || 1;
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) {
            currentPage = newPage;
            renderTable();
        }
    }

    // --- Render ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const totalItems = filteredIndices.length;
        const maxPage = Math.ceil(totalItems / itemsPerPage) || 1;
        
        document.getElementById('pageInfo').innerText = `第 ${currentPage} / ${maxPage} 页 (总计: ${totalItems} 条)`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === maxPage || totalItems === 0;
        
        if (totalItems === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#666;">无匹配数据</td></tr>'; return; }

        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const pageIndices = filteredIndices.slice(start, end);

        let html = "";
        pageIndices.forEach(idx => {
            const d = extractedData[idx];
            const warn = d.isDupe ? `<span class="alert-dupe">重名</span>` : '';
            let displayOrig = escapeHtml(d.orig).replace(/\n/g, '<br><span style="color:#444">↵</span>');
            
            html += `<tr>
                <td><span class="badge ${d.type.c}">${d.type.l}</span><div style="font-size:10px; color:#666; margin-top:2px;">${d.ctxId}</div></td>
                <td style="color:#8abeb7; font-family:monospace; font-weight:bold;">${d.cmd}</td>
                <td style="color:#aaa; font-size:13px;">${warn}${displayOrig}</td>
                <td>
                    <textarea id="t_${d.id}" 
                        oninput="autoResize(this); updateTrans(${d.id}, this.value)" 
                        onfocus="autoResize(this)"
                    >${d.trans}</textarea>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
        
        setTimeout(() => {
            pageIndices.forEach(idx => {
                const el = document.getElementById(`t_${extractedData[idx].id}`);
                if(el) {
                    const origLines = extractedData[idx].orig.split(/\r\n|\r|\n/).length;
                    const minHeight = Math.max(38, origLines * 18); 
                    el.style.height = minHeight + 'px';
                    if(el.value) autoResize(el);
                }
            });
        }, 0);
    }

    function autoResize(el) {
        el.style.height = 'auto'; 
        el.style.height = el.scrollHeight + 'px';
    }

    function updateTrans(id, val) { extractedData[id].trans = val; }

    function shouldInclude(item) {
        const cat = item.type.cat;
        
        // Epithet Check
        if (item.cmd === '#epithet') {
            return document.getElementById('cfg_nation_epithet')?.checked || false;
        }

        const cfgName = document.getElementById(`cfg_${cat}_name`)?.checked;
        const cfgDescr = document.getElementById(`cfg_${cat}_descr`)?.checked;

        if (cfgName === undefined || cfgDescr === undefined) return false;
        if(item.cmdType === 'name' && !cfgName) return false;
        if(item.cmdType === 'descr' && !cfgDescr) return false;
        return true;
    }

    // --- AI ---
    function openAIPromptModal() {
        if(!extractedData.length) return showToast("请先上传文件");
        document.getElementById('aiPromptModal').classList.add('active');
        regenerateAIPrompt();
    }

    function regenerateAIPrompt() {
        const scope = document.querySelector('input[name="aiScope"]:checked').value;
        const promptHeader = `你是一位精通策略游戏《Dominions 6》(神域6) 的专业本地化翻译专家。请帮我将以下 Mod 文本翻译成简体中文。\n【核心规则】\n1. 格式必须严格保持不变：每行开头是 {{ID:数字}}，后面紧跟原文。请输出 {{ID:数字}} 加上 翻译后的文本。\n2. 绝对不要翻译、修改或删除 {{ID:xxx}} 标签。\n3. 请以代码块格式输出结果。\n4. 遇到游戏术语请保持专业性（如 MR=魔法抗性, Protection=防御值）。\n5. 风格要求：史诗感、奇幻风格、信达雅。\n6. 如果原文包含换行符，请在译文中也保持换行。\n\n【待翻译内容】：\n`;

        let content = "";
        let count = 0;
        
        if (scope === 'all') {
            extractedData.forEach(d => {
                if(shouldInclude(d) && !d.trans) {
                    content += `{{ID:${d.id}}} ${d.orig}\n`;
                    count++;
                }
            });
        } else {
            filteredIndices.forEach(idx => {
                const d = extractedData[idx];
                if(shouldInclude(d) && !d.trans) {
                    content += `{{ID:${d.id}}} ${d.orig}\n`;
                    count++;
                }
            });
        }

        if(count === 0) content = "（没有找到未翻译的条目）";
        
        document.getElementById('aiPromptText').value = promptHeader + content;
        document.getElementById('aiCount').innerText = `准备导出: ${count} 条`;
    }

    function copyAIPrompt() {
        document.getElementById('aiPromptText').select();
        document.execCommand('copy');
        showToast("已复制提示词！");
    }

    // --- Generate ---
    function generateModFile() {
        if(!extractedData.length) return;
        let newLines = [...originalLines];
        let modifyCount = 0;
        let globalTranslationMap = {}; 

        const useGlobalSync = document.getElementById('opt_global_sync').checked;
        const forceReformat = document.getElementById('opt_force_reformat').checked;
        
        // Get specific limits
        const limitNation = parseInt(document.getElementById('limit_nation').value) || 55;
        const limitSpell = parseInt(document.getElementById('limit_spell').value) || 36;
        const limitUnit = parseInt(document.getElementById('limit_unit').value) || 42;

        extractedData.forEach(d => {
            // Logic: If translated OR (Force Reformat AND Config Checked)
            let textToUse = null;
            if (d.trans) textToUse = d.trans;
            else if (forceReformat && shouldInclude(d)) textToUse = d.orig;

            if (textToUse !== null && shouldInclude(d)) {
                let finalTrans = textToUse;
                
                // --- Force Reformat / Auto Wrap ---
                if (d.cmdType === 'descr') {
                    // Determine limit
                    let limit = 42; 
                    if (d.type.cat === 'nation') limit = limitNation;
                    else if (d.type.cat === 'spell') limit = limitSpell;
                    else limit = limitUnit;

                    // Clean existing newlines first if force reformatting logic implies reflow
                    // To safely reflow English/Chinese mix, we might just strip \n and re-chunk
                    let clean = finalTrans.replace(/\r?\n/g, ''); 
                    
                    // Regex to split every N chars
                    if (clean.length > limit) {
                        let regex = new RegExp(`.{1,${limit}}`, 'g');
                        let parts = clean.match(regex);
                        if(parts) finalTrans = parts.join('\n');
                    }
                }

                // REMOVED Anti-Clip logic

                newLines[d.startLine] = `${d.cmd} "${finalTrans}"`;
                for(let k = d.startLine + 1; k <= d.endLine; k++) {
                    newLines[k] = "__DELETED_LINE__";
                }
                modifyCount++;

                // Global Sync (Excluding Epithet)
                if (d.cmdType === 'name' && d.cmd !== '#epithet' && useGlobalSync && d.trans) {
                    globalTranslationMap[d.orig] = d.trans; // Only sync translated names
                }
            }
        });

        newLines = newLines.filter(l => l !== "__DELETED_LINE__");

        if (useGlobalSync && Object.keys(globalTranslationMap).length > 0) {
            newLines = newLines.map(line => {
                const trimLine = line.trim();
                if (!trimLine.startsWith('#')) return line;
                const match = trimLine.match(/^(#\w+)\s+"([^"]*)"/);
                if (match) {
                    const cmd = match[1];
                    const content = match[2];
                    if (!noReplaceCmds.includes(cmd) && globalTranslationMap[content]) {
                        return line.replace(`"${content}"`, `"${globalTranslationMap[content]}"`);
                    }
                }
                return line;
            });
        }

        const finalContent = newLines.join(detectedLineEnding);
        const blob = new Blob(["\uFEFF" + finalContent], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_CN.dm`;
        a.click();
        showToast(`生成成功！`);
    }

    function processImport() {
        const text = document.getElementById('pasteArea').value;
        const chunks = text.split(/\{\{ID[:：](\d+)\}\}/);
        let count = 0;
        for(let i=1; i<chunks.length; i+=2) {
            let id = parseInt(chunks[i]);
            let content = chunks[i+1].trim();
            content = content.replace(/```$/, "").trim();
            if(extractedData[id]) {
                extractedData[id].trans = content;
                count++;
            }
        }
        document.getElementById('importModal').classList.remove('active');
        showToast(`导入 ${count} 条数据`);
        filterData();
    }

    function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>